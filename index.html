<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIC AI ‚Äî CRION</title>
<style>
  :root{ --base-font:12px; --brand:#2882bb; --brand2:#2a8fcf; --bg:#f7f8fc; --ink:#0f172a; --muted:#667085; --line:#E7EAF3;
         --lime:#22c55e; --lime2:#a3e635; --danger:#ef4444; --tag:#F2E7FF; --tag-ink:#6D28D9;
         --tag-shadow:0 4px 10px rgba(40,130,187,.18); --card-shadow:0 18px 36px rgba(99,102,241,.12), 0 8px 24px rgba(40,130,187,.10); }
  *{box-sizing:border-box}
  body{ margin:0; font:var(--base-font)/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; color:var(--ink);
        background:radial-gradient(1200px 520px at -10% -10%, #eaf4ff 0, #ffffff 60%, #f7faff 100%);}
  .wrap{max-width:1290px;margin:0 auto;padding:16px}

  /* HEADER */
  .hero{display:flex;align-items:center;gap:12px;border-radius:18px;padding:12px 16px;color:#fff;
        background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 24px 56px rgba(40,130,187,.22);min-height:78px}
  .hero-left{display:flex;align-items:center;gap:10px}
  .hero-center{flex:1}
  .hero-right{display:flex;align-items:center;gap:12px}
  .logo-left,.logo-hds{height:44px;object-fit:contain;filter:drop-shadow(0 2px 6px #0002)}
  .iconbtn{width:36px;height:36px;border-radius:12px;border:1px solid #ffffff40;display:grid;place-items:center;cursor:pointer;backdrop-filter:blur(4px);
           transition:.15s;box-shadow:0 6px 14px rgba(0,0,0,.15)}
  .iconbtn:hover{transform:translateY(-1px)}
  .icon-note{background:#ffd95e}.icon-calc{background:#60a5fa}
  @media (max-width:980px){ .logo-left,.logo-hds{height:34px} .iconbtn{width:34px;height:34px} }

  /* LAYOUT */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px;box-shadow:var(--card-shadow)}
  .tag{display:inline-flex;align-items:center;gap:8px;background:var(--tag);color:var(--tag-ink);border:1px solid #eadbff;border-radius:999px;
       padding:6px 12px;font-weight:800;font-size:12px;box-shadow:var(--tag-shadow)}
  h2{margin:8px 0 10px;font-size:18px}
  .row{display:flex;gap:10px;align-items:center}

  .input{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fbfcff}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;user-select:none}
  .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn-search{color:#053;background:linear-gradient(135deg,var(--lime),var(--lime2));box-shadow:0 10px 22px rgba(34,197,94,.28)}
  .btn-plain{background:#f7f7fb;color:#111;border:1px solid var(--line)}

  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .out{white-space:pre-wrap;min-height:90px;border:1px dashed #c9d5ea;border-radius:12px;padding:10px;margin-top:10px;background:#f3f6ff;color:#0f172a}
  .out-alert{min-height:60px;padding:12px;text-align:center}
  #alertMsg{font-size:24px;font-weight:900;color:#991b1b;margin:0 0 6px} #alertResp{margin:0}

  .list{margin:8px 0 0;padding:0;list-style:none}
  .item{padding:10px 0;border-top:1px solid var(--line)}
  .snip{color:#374151;font-size:13px;margin:6px 0}

  .busy{display:flex;align-items:center;gap:8px}
  .spinner{width:16px;height:16px;border-radius:50%;border:3px solid #ffffff66;border-top-color:#fff;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .bar{position:relative;height:6px;border-radius:999px;background:#e9e9ff;overflow:hidden}
  .bar:before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,#c7b8ff,#a78bfa,#93c5fd);animation:load 1.2s infinite}
  @keyframes load{0%{left:-100%;right:100%}50%{left:0;right:0}100%{left:100%;right:-100%}}

  footer{margin:18px 0 6px;text-align:center}
  .copyright{font-size:12px;font-weight:700;color:#2882bb;padding:10px 12px;border-radius:10px;background:rgba(40,130,187,.06);display:inline-block}
  .credit{margin-top:4px;font-size:6px;color:#cfd6e3;display:block}
</style>
</head>
<body>
  <div class="wrap">
    <!-- HEADER -->
    <div class="hero">
      <div class="hero-left">
        <img class="logo-left" src="icon2.png"
             onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/icon2.png';" alt="CRION">
      </div>
      <div class="hero-center"></div>
      <div class="hero-right">
        <button id="toggleNote" type="button" class="iconbtn icon-note" title="Post-it">üóíÔ∏è</button>
        <button id="toggleCalc" type="button" class="iconbtn icon-calc" title="Calculadora">üßÆ</button>
        <img class="logo-hds" src="HDS.png"
             onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/HDS.png';" alt="HDSTEC">
      </div>
    </div>

    <!-- Widgets flutuantes -->
    <div id="noteWrap" style="position:fixed;right:18px;top:84px;z-index:50;display:none;width:240px;background:#fff3b0;border:1px solid #f5d565;border-radius:12px;box-shadow:0 14px 30px #0001;padding:10px">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <b>Post-it</b>
        <div class="row" style="gap:6px">
          <button id="clearNote" type="button" class="btn btn-plain" style="padding:4px 8px">Limpar</button>
          <button id="closeNote" type="button" class="btn btn-plain" style="padding:4px 8px">Fechar</button>
        </div>
      </div>
      <textarea id="noteArea" placeholder="Anote algo..." style="width:100%;height:120px;border:0;background:transparent;outline:none;font:14px/1.45 ui-sans-serif"></textarea>
    </div>

    <div id="calcWrap" style="position:fixed;right:18px;top:84px;z-index:50;display:none;width:260px;background:#fff;border:1px solid #dbe0ea;border-radius:12px;box-shadow:0 14px 30px #0001;padding:12px">
      <div class="row" style="justify-content:space-between;margin-bottom:6px"><b>Calculadora</b><button id="closeCalc" type="button" class="btn btn-plain" style="padding:4px 8px">Fechar</button></div>
      <div class="screen" id="scr" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-weight:700;margin-bottom:10px;background:#f9fbff">0</div>
      <div id="keys" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
        <div class="key op" data-k="C">C</div><div class="key op" data-k="¬±">¬±</div><div class="key op" data-k="%">%</div><div class="key op" data-k="/">√∑</div>
        <div class="key" data-k="7">7</div><div class="key" data-k="8">8</div><div class="key" data-k="9">9</div><div class="key op" data-k="*">√ó</div>
        <div class="key" data-k="4">4</div><div class="key" data-k="5">5</div><div class="key" data-k="6">6</div><div class="key op" data-k="-">‚àí</div>
        <div class="key" data-k="1">1</div><div class="key" data-k="2">2</div><div class="key" data-k="3">3</div><div class="key op" data-k="+">+</div>
        <div class="key" data-k="0">0</div><div class="key" data-k="00">00</div><div class="key" data-k=".">.</div><div class="key eq" data-k="=">=</div>
      </div>
      <style>
        .key{padding:10px;border-radius:10px;border:1px solid #e6e9f2;background:#f7f8fd;cursor:pointer;text-align:center;font-weight:800}
        .key.op{background:#eef6ff;border-color:#cfe7ff}
        .key.eq{background:linear-gradient(135deg,var(--lime),var(--lime2));color:#053}
      </style>
    </div>

    <!-- GRID -->
    <div class="grid">
      <!-- ALERTA -->
      <section class="card">
        <div class="tag">ALERTA</div>
        <h2>Controle de alerta</h2>
        <div class="row"><button id="btnAlert" type="button" class="btn btn-search">Pesquisar</button></div>
        <div class="hint" id="alertBusy" style="display:none"><div class="busy"><div class="spinner"></div><div>Pesquisando alerta...</div></div><div class="bar" style="margin-top:6px"></div></div>
        <div id="alertBox" class="out out-alert" style="display:none"><div id="alertMsg">‚Äî</div><div id="alertResp" class="hint">‚Äî</div></div>
      </section>

      <!-- SITES OFICIAIS (via GAS scraping) -->
      <section class="card">
        <div class="tag">SITES OFICIAIS</div>
        <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
        <div class="row" style="margin-top:6px">
          <input id="qSites" class="input" placeholder='Digite sua pergunta ..... (ex.: "vencimento hapvida")'>
          <button id="btnSites" type="button" class="btn btn-search">Pesquisar</button>
        </div>
        <div class="hint" id="sitesBusy" style="display:none"><div class="busy"><div class="spinner"></div><div>Pesquisando...</div></div><div class="bar" style="margin-top:6px"></div></div>
        <div id="outSites" class="out">‚Äî</div>
      </section>

      <!-- BANNER RR -->
      <section class="card" style="background:transparent;border:0;box-shadow:none">
        <img src="rr.png" alt="RIC" style="display:block;width:100%;height:auto;object-fit:contain;filter:drop-shadow(0 24px 56px rgba(99,102,241,.22))"
             onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/rr.png';">
      </section>

      <!-- PROCEDIMENTOS CRION -->
      <section class="card">
        <div class="tag">PROCEDIMENTOS CRION</div>
        <h2>Procedimentos</h2>
        <p class="hint">Material de Treinamento, Quiz, Alertas &gt; 30 dias e demais informa√ß√µes.</p>
        <div class="row">
          <input id="qCRION" class="input" placeholder="Ex.: Onboarding, Reten√ß√£o, URA, Script de Cobran√ßa, Affix">
          <button id="btnCRION" type="button" class="btn btn-search" style="min-width:112px">Pesquisar</button>
        </div>
        <div class="hint" id="crionBusy" style="display:none"><div class="busy"><div class="spinner"></div><div>Listando procedimentos...</div></div><div class="bar" style="margin-top:6px"></div></div>
        <div class="out" id="crionBox"><div id="crionStatus" class="hint" style="margin-top:0">‚Äî</div><ul id="crionList" class="list"></ul></div>
      </section>
    </div>

    <footer>
      <span class="copyright">¬© 2025 Copyright: HDSTEC. Todos os Direitos Reservados v3.0.0 -Operacao</span>
      <span class="credit">desenvolvido por Alexandre Cavalcante</span>
    </footer>
  </div>

<script>
/* ======= CONFIG ======= */
/* use o MESMO URL do seu GAS (o que j√° funciona no alerta): */
const APP_URL = "https://script.google.com/macros/s/AKfycbxnTEhSw1u5Ib0jCqJsURoZM30VfCpfeqKqKvYpXdKgJDUPrw8Q8hScbSzw4zVkI7u0rw/exec";

/* ======= HELPERS ======= */
const $  = s => document.querySelector(s);
const show = (el,on=true)=>{ if(!el) return; el.style.display = on? "" : "none"; };
const esc  = s => String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
function humanSize(b){ if(!b||b<=0) return "‚Äî"; const u=["B","KB","MB","GB"]; let i=0; while(b>=1024&&i<u.length-1){ b/=1024; i++; } return b.toFixed(2)+" "+u[i]; }

/* fetch com timeout maior (evita ‚ÄúFailed to fetch‚Äù no chat) */
async function fetchTimed(url, opts={}, ms=45000){
  const ctrl = new AbortController(); const id=setTimeout(()=>ctrl.abort(), ms);
  try{ return await fetch(url, {...opts, signal:ctrl.signal}); }
  finally{ clearTimeout(id); }
}

/* ======= CHAMADAS GAS (REST simples) ======= */
async function call(endpoint, payload){
  const url = APP_URL + "?fn=" + encodeURIComponent(endpoint);
  try{
    const r = await fetchTimed(url, {method:"POST", headers:{"Content-Type":"text/plain"}, body:JSON.stringify(payload||{})}, 45000);
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  }catch(e){
    throw new Error("Sem conex√£o com o servidor (GAS).");
  }
}

/* ======= APP ======= */
document.addEventListener('DOMContentLoaded', () => {
  /* Post-it */
  const noteWrap=$('#noteWrap'), noteArea=$('#noteArea');
  $('#toggleNote').onclick = ()=>{ noteWrap.style.display = noteWrap.style.display? "" : "block"; if(noteWrap.style.display) noteArea.focus(); };
  $('#clearNote').onclick = ()=>{ noteArea.value=""; localStorage.removeItem('ric_note'); };
  $('#closeNote').onclick = ()=>{ noteWrap.style.display="none"; };
  noteArea.value = localStorage.getItem('ric_note') || "";
  noteArea.addEventListener('input', ()=> localStorage.setItem('ric_note', noteArea.value));

  /* Calculadora */
  $('#toggleCalc').onclick = ()=>{ $('#calcWrap').style.display = $('#calcWrap').style.display? "" : "block"; };
  $('#closeCalc').onclick = ()=>{ $('#calcWrap').style.display="none"; };
  $('#keys').addEventListener('click', e=>{
    const k=e.target.dataset.k; if(!k) return;
    const scr=$('#scr'); let val=scr.textContent;
    if(/\d/.test(k)){ scr.textContent = (val==='0')? k : val+k; return; }
    if(k==='00'){ scr.textContent = (val==='0')? '0' : val+'00'; return; }
    if(k==='.') { if(!val.includes('.')) scr.textContent = val+'.'; return; }
    if(k==='C'){ scr.textContent='0'; return; }
    if(k==='¬±'){ scr.textContent = val.startsWith('-')? val.slice(1) : (val==='0'?'0':'-'+val); return; }
    if(k==='%'){ scr.textContent = String(parseFloat(val||'0')/100); return; }
    if("+-*/".includes(k)){ scr.dataset.op=k; scr.dataset.mem=val; scr.textContent='0'; return; }
    if(k==='='){ const a=parseFloat(scr.dataset.mem||'0'), b=parseFloat(val||'0'); const op=scr.dataset.op||'+'; let r=0;
      r = op==='+'? a+b : op==='-'? a-b : op==='*'? a*b : (b===0? 'Erro' : a/b); scr.textContent=String(r); scr.dataset.op=''; scr.dataset.mem='0'; }
  });

  /* ALERTA (GAS) */
  $('#btnAlert').addEventListener('click', async ()=>{
    show($('#alertBusy'),true); show($('#alertBox'),false);
    try{
      const r = await call('getalert', {});
      const msg = (r && r.found) ? ("üö® " + String(r.mensagem||"‚Äî").toUpperCase()) : "Sem recado no momento.";
      $('#alertMsg').textContent = msg;
      $('#alertResp').textContent = r && r.responsavel ? String(r.responsavel||"").toLowerCase() : "";
      show($('#alertBox'),true);
    }catch(e){
      $('#alertMsg').textContent = "Erro: " + e.message;
      $('#alertResp').textContent = "";
      show($('#alertBox'),true);
    }finally{ show($('#alertBusy'),false); }
  });

  /* SITES OFICIAIS ‚Äî usa seu GAS (chatServer com scraping Affix/Alter/Hapvida) */
  $('#btnSites').addEventListener('click', doSites);
  $('#qSites').addEventListener('keydown', e=>{ if(e.key==='Enter') doSites(); });

  async function doSites(){
    const q = ($('#qSites').value||'').trim();
    if(!q){ $('#outSites').textContent='Digite a pergunta.'; return; }
    show($('#sitesBusy'),true); $('#outSites').textContent='‚Äî';
    try{
      const r = await call('chat', { q, ua: navigator.userAgent||'' });
      const txt = (r && r.text) ? r.text : '‚Äî';
      // transforma URLs em links e mant√©m quebras de linha
      const html = String(txt)
        .replace(/(https?:\/\/[^\s]+)/g, m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`)
        .replace(/\n/g,'<br>');
      $('#outSites').innerHTML = html;
    }catch(e){
      $('#outSites').textContent = 'Erro: ' + e.message;  // ex.: sem conex√£o ou timeout
    }finally{
      show($('#sitesBusy'),false);
    }
  }

  /* CRION (GAS) */
  $('#btnCRION').addEventListener('click', doCRION);
  $('#qCRION').addEventListener('keydown', e=>{ if(e.key==='Enter') doCRION(); });
  async function doCRION(){
    const q=(($('#qCRION').value)||'').trim(); if(!q){ $('#crionStatus').textContent='Digite um termo.'; return; }
    show($('#crionBusy'),true); $('#crionStatus').textContent='Listando arquivos‚Ä¶'; $('#crionList').innerHTML="";
    try{
      const r = await call('searchcrion', {q});
      const items=r.items||[]; $('#crionStatus').textContent=`Resultados: ${items.length}`;
      const frag=document.createDocumentFragment();
      items.forEach((it,idx)=>{
        const li=document.createElement('li'); li.className='item'; li.id='crion_'+idx;
        const meta  = `<div class="hint">Tamanho: ${humanSize(it.size||0)} ‚Ä¢ Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "‚Äî"}</div>`;
        li.innerHTML=`<div><b>${esc(it.name)}</b> ‚Ä¢ <a href="${it.url}" target="_blank" rel="noopener">Abrir</a></div>${meta}
                      <div class="hint" id="snip_crion_${idx}">Carregando pr√©vias‚Ä¶</div>`;
        frag.appendChild(li);
      });
      $('#crionList').appendChild(frag);
      if(items.length){
        let from=0; while(from<items.length){
          const x = await call('fetchcrionsnippets', {sessionId:r.sessionId, from, limit:6});
          (x.items||[]).forEach(row=>{
            const el=$('#snip_crion_'+row.index);
            el.innerHTML=(row.snippets && row.snippets.length)
              ? row.snippets.map(s=>`<div class="snip">${esc(s)}</div>`).join("")
              : '<span class="hint">‚Äî</span>';
          });
          from = x.to;
        }
        $('#crionStatus').textContent += " ‚Ä¢ pr√©vias completas";
      }
    }catch(e){ $('#crionStatus').textContent='Erro: '+e.message; }
    finally{ show($('#crionBusy'),false); }
  }
});
</script>
</body>
</html>

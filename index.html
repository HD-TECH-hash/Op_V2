<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIC AI ‚Äî CRION</title>
<style>
  :root{
    --base-font:12px;
    --brand:#2882bb; --brand2:#2a8fcf;
    --bg:#f7f8fc; --ink:#0f172a; --muted:#667085; --line:#E7EAF3;
    --lime:#22c55e; --lime2:#a3e635;
    --tag:#F2E7FF; --tag-ink:#6D28D9; --card-shadow:0 18px 36px rgba(99,102,241,.12), 0 8px 24px rgba(40,130,187,.10);
  }
  *{box-sizing:border-box} body{margin:0;font:var(--base-font)/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--ink);background:radial-gradient(1200px 520px at -10% -10%, #eaf4ff 0, #ffffff 60%, #f7faff 100%)}
  .wrap{max-width:1290px;margin:0 auto;padding:16px}
  .hero{position:relative;min-height:78px;border-radius:18px;padding:12px 16px;display:flex;align-items:center;justify-content:center;color:#fff;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 24px 56px rgba(40,130,187,.22)}
  .left-img{position:absolute;left:14px;top:50%;transform:translateY(-50%);height:38px}
  .right-img{position:absolute;right:14px;top:50%;;height:38px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .right-img{display:none} .left-img{left:10px;height:22px} }
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px;box-shadow:var(--card-shadow)}
  .tag{display:inline-flex;align-items:center;gap:8px;background:var(--tag);color:var(--tag-ink);border:1px solid #eadbff;border-radius:999px;padding:6px 12px;font-weight:800;font-size:12px}
  h2{margin:8px 0 10px;font-size:18px}
  .row{display:flex;gap:10px;align-items:center}
  .input{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fbfcff}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn-search{color:#053;background:linear-gradient(135deg,var(--lime),var(--lime2))}
  .btn-plain{background:#f7f7fb;color:#111;border:1px solid var(--line)}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .out{white-space:pre-wrap;min-height:90px;border:1px dashed #c9d5ea;border-radius:12px;padding:10px;margin-top:10px;background:#f3f6ff;color:#0f172a}
  .list{margin:8px 0 0;padding:0;list-style:none}
  .item{padding:10px 0;border-top:1px solid var(--line)}
  .file-head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .file-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .btn-sm{padding:6px 10px;font-size:12px}
  footer{margin:18px 0 6px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <img class="left-img" src="icon2.png" onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/icon2.png';" alt="">
      <img class="right-img" src="HDS.png" onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/HDS.png';" alt="">
    </div>

    <div class="grid">
      <section class="card">
        <div class="tag">ALERTA</div>
        <h2>Controle de alerta</h2>
        <div class="row"><button id="btnAlert" type="button" class="btn btn-search">Pesquisar</button></div>
        <div class="hint" id="alertBusy" style="display:none">Pesquisando alerta‚Ä¶</div>
        <div id="alertBox" class="out" style="display:none"></div>
      </section>

      <section class="card">
        <div class="tag">SITES OFICIAIS</div>
        <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
        <div class="row" style="margin-top:6px">
          <input id="qSites" class="input" placeholder='Digite sua pergunta ..... (ex.: "manual")'>
          <button id="btnSites" type="button" class="btn btn-search">Pesquisar</button>
        </div>
        <div class="hint" id="sitesBusy" style="display:none">Pesquisando‚Ä¶</div>
        <div id="outSites" class="out">‚Äî</div>
      </section>

      <section class="card">
        <div class="tag">PROCEDIMENTOS CRION</div>
        <h2>Procedimentos</h2>
        <p class="hint">Material de Treinamento, Quiz, Alertas &gt; 30 dias e demais informa√ß√µes.</p>
        <div class="row">
          <input id="qCRION" class="input" placeholder="Ex.: Onboarding, Reten√ß√£o, URA, Script de Cobran√ßa, Affix">
          <button id="btnCRION" type="button" class="btn btn-search" style="min-width:112px">Pesquisar</button>
        </div>
        <div class="hint" id="crionBusy" style="display:none">Listando procedimentos‚Ä¶</div>
        <div class="out" id="crionBox">
          <div id="crionStatus" class="hint" style="margin-top:0">‚Äî</div>
          <ul id="crionList" class="list"></ul>
        </div>
      </section>
    </div>

    <footer>
      <span style="font-size:12px;font-weight:700;color:#2882bb">¬© 2025 HDSTEC ‚Äî v3.0.0 Opera√ß√£o</span>
    </footer>
  </div>

<script>
/* ======= CONFIG (GAS) ======= */
const APP_URL = "https://script.google.com/macros/s/AKfycbxnTEhSw1u5Ib0jCqJsURoZM30VfCpfeqKqKvYpXdKgJDUPrw8Q8hScbSzw4zVkI7u0rw/exec";

/* ======= HELPERS ======= */
const $  = sel => document.querySelector(sel);
const show = (el, on=true)=>{ if(!el) return; el.style.display = on? "" : "none"; };
const esc  = s => String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
function humanSize(b){ if(!b||b<=0) return "‚Äî"; const u=["B","KB","MB","GB"]; let i=0; while(b>=1024&&i<u.length-1){ b/=1024; i++; } return b.toFixed(2)+" "+u[i]; }

/* ======= GITHUB (repo + pages) ======= */
const GH_OWNER = "HD-TECH-hash";
const GH_REPO  = "Ricai-crion-operacao";
const RAW_BASE   = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/main`;
const PAGES_BASE = `https://${GH_OWNER}.github.io/${GH_REPO}`;

/* Constr√≥i URL est√°vel de visualiza√ß√£o no GitHub Pages */
function pagesPdfUrl(name){
  // evita 'download' do raw; usa Pages que abre inline
  return `${PAGES_BASE}/data/affix/raw/${encodeURIComponent(name)}`;
}

/* Lista PDFs presentes no reposit√≥rio */
async function listRepoPdfs(){
  const api = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/data/affix/raw?ref=main`;
  const r = await fetch(api, {cache:'no-store'}); if(!r.ok) return [];
  const arr = await r.json();
  return arr
    .filter(it => it.type==="file" && /\.pdf$/i.test(it.name))
    .map(it => ({
      name: it.name,
      size: it.size||0,
      openUrl: pagesPdfUrl(it.name),   // <‚Äî abre inline em nova aba
      origin: "repo"
    }));
}

/* L√™ manifest.json e traz SOMENTE status=ok */
async function listManifestPdfs(){
  try{
    const r = await fetch(`${RAW_BASE}/data/affix/manifest.json?ts=${Date.now()}`, {cache:'no-store'});
    if(!r.ok) return [];
    const j = await r.json();
    return (j.items||[])
      .filter(x => x && x.url && /\.pdf$/i.test(x.url) && (x.status === "ok"))
      .map(x => {
        const name = x.name || x.url.split('/').pop();
        // se baixou, preferir o Pages (inline). Se n√£o, usar link externo.
        const openUrl = x.repo_raw ? pagesPdfUrl(name) : x.url;
        return { name, size: x.size||0, openUrl, origin: x.repo_raw ? "repo" : "external" };
      });
  }catch(_){ return []; }
}

/* ======= UI ======= */
document.addEventListener('DOMContentLoaded', () => {
  // ALERTA
  $('#btnAlert')?.addEventListener('click', async ()=>{
    show($('#alertBusy'),true); show($('#alertBox'),false);
    try{
      const r = await fetch(APP_URL+"?fn=getalert", {method:"POST",headers:{"Content-Type":"text/plain"},body:"{}"}).then(r=>r.json());
      const msg = (r && r.found) ? ("üö® " + String(r.mensagem||"‚Äî").toUpperCase()) : "Sem recado no momento.";
      $('#alertBox').innerHTML = `<div style="font-weight:900">${esc(msg)}</div><div class="hint">${esc(r?.responsavel||'')}</div>`;
      show($('#alertBox'),true);
    }catch(e){
      $('#alertBox').textContent = "Erro: " + e.message;
      show($('#alertBox'),true);
    }finally{ show($('#alertBusy'),false); }
  });

  // SITES OFICIAIS
  $('#btnSites')?.addEventListener('click', doSites);
  $('#qSites')?.addEventListener('keydown', e=>{ if(e.key==='Enter') doSites(); });

  async function doSites(){
    const q=(($('#qSites').value)||'').trim().toLowerCase();
    show($('#sitesBusy'),true);
    const box = $('#outSites'); box.innerHTML = "‚Äî";

    try{
      const [repo, manifest] = await Promise.all([listRepoPdfs(), listManifestPdfs()]);
      // junta e de-duplica por nome (prioriza repo)
      const map = new Map();
      for (const it of [...manifest, ...repo]){ if(!map.has(it.name)) map.set(it.name, it); }
      let items = [...map.values()];
      if(q) items = items.filter(it => it.name.toLowerCase().includes(q));

      const frag = document.createDocumentFragment();
      const meta = document.createElement('div');
      meta.className='hint';
      meta.textContent = `Resultados: ${items.length} ‚Ä¢ filtro: ‚Äú${q||'*'}‚Äù`;
      frag.appendChild(meta);

      for (const it of items){
        const wrap = document.createElement('div'); wrap.className='item';

        const head = document.createElement('div'); head.className='file-head';
        head.innerHTML = `<div><b>${esc(it.name)}</b>${it.origin==='external' ? ' <span class="hint">(link externo)</span>':''}</div>`;
        wrap.appendChild(head);

        const actions = document.createElement('div'); actions.className='file-actions';

        // Abrir ‚Äî nova aba SEM download (Pages ou externo)
        const btnOpen = document.createElement('button');
        btnOpen.className='btn btn-plain btn-sm'; btnOpen.textContent='Abrir';
        btnOpen.addEventListener('click', ()=> window.open(it.openUrl, '_blank', 'noopener,noreferrer'));
        actions.appendChild(btnOpen);

        // Pr√©via ‚Äî inline com <embed>; fallback p/ Google Viewer no <object>
        const btnPrev = document.createElement('button');
        btnPrev.className='btn btn-plain btn-sm'; btnPrev.textContent='Pr√©via';
        btnPrev.addEventListener('click', ()=>{
          const id = 'prev_'+btoa(it.openUrl).replace(/=+/g,'');
          let prev = document.getElementById(id);
          if(prev){ prev.remove(); return; }
          prev = document.createElement('div'); prev.id = id; prev.style.marginTop='8px';

          const gview = `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(it.openUrl)}`;
          prev.innerHTML = `
            <object data="${it.openUrl}" type="application/pdf" style="width:100%;height:520px;border:1px solid var(--line);border-radius:10px">
              <iframe src="${gview}" style="width:100%;height:520px;border:1px solid var(--line);border-radius:10px"></iframe>
            </object>`;
          wrap.appendChild(prev);
        });
        actions.appendChild(btnPrev);

        const meta2 = document.createElement('div'); meta2.className='hint';
        meta2.textContent = `Tamanho: ${humanSize(it.size||0)}`;
        wrap.appendChild(actions); wrap.appendChild(meta2);

        frag.appendChild(wrap);
      }

      box.innerHTML = ''; box.appendChild(frag);
    }catch(e){
      box.textContent = 'Erro: '+e.message;
    }finally{
      show($('#sitesBusy'),false);
    }
  }

  // CRION (GAS)
  $('#btnCRION')?.addEventListener('click', async ()=>{
    const q=(($('#qCRION').value)||'').trim(); if(!q){ $('#crionStatus').textContent='Digite um termo.'; return; }
    show($('#crionBusy'),true); $('#crionStatus').textContent='Listando arquivos‚Ä¶'; $('#crionList').innerHTML="";
    try{
      const r = await fetch(APP_URL+"?fn=searchcrion", {method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({q})}).then(r=>r.json());
      const items=r.items||[]; $('#crionStatus').textContent=`Resultados: ${items.length}`;
      const frag=document.createDocumentFragment();
      items.forEach((it,idx)=>{
        const li=document.createElement('li'); li.className='item'; li.id='crion_'+idx;
        const meta  = `<div class="hint">Tamanho: ${humanSize(it.size||0)} ‚Ä¢ Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "‚Äî"}</div>`;
        li.innerHTML=`<div><b>${esc(it.name)}</b> ‚Ä¢ <a href="${it.url}" target="_blank" rel="noopener">Abrir</a></div>${meta}
                      <div class="hint" id="snip_crion_${idx}">Carregando pr√©vias‚Ä¶</div>`;
        frag.appendChild(li);
      });
      $('#crionList').appendChild(frag);

      if(items.length){
        let from=0;
        const sid = r.sessionId;
        while(from<items.length){
          const x = await fetch(APP_URL+"?fn=fetchcrionsnippets", {method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({sessionId:sid,from,limit:6})}).then(r=>r.json());
          (x.items||[]).forEach(row=>{
            const el=$('#snip_crion_'+row.index);
            el.innerHTML=(row.snippets && row.snippets.length)
              ? row.snippets.map(s=>`<div style="color:#374151;font-size:13px;margin:6px 0">${esc(s)}</div>`).join("")
              : '<span class="hint">‚Äî</span>';
          });
          from = x.to;
        }
        $('#crionStatus').textContent += " ‚Ä¢ pr√©vias completas";
      }
    }catch(e){ $('#crionStatus').textContent='Erro: '+e.message; }
    finally{ show($('#crionBusy'),false); }
  });
});
</script>
</body>
</html>

<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIC AI — CRION</title>
<style>
  :root{
    --base-font:12px;
    --brand:#2882bb; --brand2:#2a8fcf;
    --bg:#f7f8fc; --ink:#0f172a; --muted:#667085; --line:#E7EAF3;
    --lime:#22c55e; --lime2:#a3e635; --danger:#ef4444;
    --tag:#F2E7FF; --tag-ink:#6D28D9; --tag-shadow:0 4px 10px rgba(40,130,187,.18);
    --card-shadow:0 18px 36px rgba(99,102,241,.12), 0 8px 24px rgba(40,130,187,.10);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font:var(--base-font)/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; color:var(--ink);
    background:radial-gradient(1200px 520px at -10% -10%, #eaf4ff 0, #ffffff 60%, #f7faff 100%);
  }
  .wrap{max-width:1290px;margin:0 auto;padding:16px}

  /* HEADER */
  .hero{
    position:relative; min-height:78px; border-radius:18px; padding:12px 16px;
    display:flex; align-items:center; justify-content:center; color:#fff;
    background:linear-gradient(135deg,var(--brand),var(--brand2));
    box-shadow:0 24px 56px rgba(40,130,187,.22);
  }
  .hero .logo{width:120px;height:auto;object-fit:contain;filter:drop-shadow(0 2px 6px #0002)}
  .left-img{position:absolute; left:14px; top:50%; transform:translateY(-50%); height:38px; object-fit:contain; filter:drop-shadow(0 2px 4px #0002)}
  .right-img{position:absolute;right:14px;top:50%;transform:translateY(-50%)}
  .tools{position:absolute; right:148px; top:50%; transform:translateY(-50%); display:flex; gap:10px; align-items:center}
  .iconbtn{width:36px;height:36px;border-radius:12px;border:1px solid #ffffff40; display:grid;place-items:center;cursor:pointer;backdrop-filter:blur(4px); transition:.15s; box-shadow:0 6px 14px rgba(0,0,0,.15)}
  .iconbtn:hover{transform:translateY(-1px)}
  .icon-note{background:#ffd95e} .icon-calc{background:#60a5fa}
  .iconbtn svg{display:block}

  /* GRID / CARDS */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}.right-img{display:none}.tools{right:14px}.left-img{left:10px;height:22px}}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px;box-shadow:var(--card-shadow)}
  .tag{display:inline-flex;align-items:center;gap:8px;background:var(--tag);color:var(--tag-ink);border:1px solid #eadbff;border-radius:999px;padding:6px 12px;font-weight:800;font-size:12px;box-shadow:var(--tag-shadow)}
  h2{margin:8px 0 10px;font-size:18px}
  .row{display:flex;gap:10px;align-items:center}
  .input{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fbfcff}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;user-select:none}
  .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn-search{color:#053;background:linear-gradient(135deg,var(--lime),var(--lime2));box-shadow:0 10px 22px rgba(34,197,94,.28)}
  .btn-plain{background:#f7f7fb;color:#111;border:1px solid var(--line)}
  .btn-danger{background:var(--danger);color:#fff;box-shadow:0 10px 22px rgba(239,68,68,.24)}
  .btn-reindex{padding:6px 10px;font-size:.78rem;position:relative;top:-3px}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .out{white-space:pre-wrap;min-height:90px;border:1px dashed #c9d5ea;border-radius:12px;padding:10px;margin-top:10px;background:#f3f6ff;color:#0f172a;box-shadow:inset 0 1px 0 #ffffffcc}
  .out-alert{min-height:60px;padding:12px;text-align:center}
  #alertMsg{font-size:24px;font-weight:900;color:#991b1b;margin:0 0 6px} #alertResp{margin:0}
  .list{margin:8px 0 0;padding:0;list-style:none} .item{padding:10px 0;border-top:1px solid var(--line)}
  .snip{color:#374151;font-size:13px;margin:6px 0}
  .busy{display:flex;align-items:center;gap:8px}
  .spinner{width:16px;height:16px;border-radius:50%;border:3px solid #ffffff66;border-top-color:#fff;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .bar{position:relative;height:6px;border-radius:999px;background:#e9e9ff;overflow:hidden}
  .bar:before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,#c7b8ff,#a78bfa,#93c5fd);animation:load 1.2s infinite}
  @keyframes load{0%{left:-100%;right:100%}50%{left:0;right:0}100%{left:100%;right:-100%}}

  /* SLOT LIVRE (RR com sombra roxa) */
  .free-card{background:transparent;border:0;box-shadow:none;padding:0}
  .free-pad{padding:10px}
  .rr-img{display:block;width:100%;height:auto;object-fit:contain;pointer-events:none;filter:drop-shadow(0 24px 56px rgba(99,102,241,.22));}

  /* MINI-THUMB */
  .thumb{width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--line);box-shadow:0 6px 14px rgba(99,102,241,.16), 0 3px 8px rgba(40,130,187,.10)}
  .file-head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .file-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .btn-sm{padding:6px 10px;font-size:12px}
  footer{margin:18px 0 6px;text-align:center}
  .copyright{font-size:12px;font-weight:700;color:#2882bb;padding:10px 12px;border-radius:10px;background:rgba(40,130,187,.06);display:inline-block}
  .credit{margin-top:4px;font-size:6px;color:#cfd6e3;display:block}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <img class="left-img" src="icon2.png" onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/icon2.png';" alt="Logo esquerdo">
      <div class="tools">
        <button id="toggleNote" type="button" class="iconbtn icon-note" title="Post-it">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 3h8a3 3 0 0 1 3 3v7l-7 7H8a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3Z" stroke="#1f2937" stroke-width="2" fill="#fde68a"/><path d="M19 13h-4a3 3 0 0 0-3 3v4" stroke="#1f2937" stroke-width="2"/></svg>
        </button>
        <button id="toggleCalc" type="button" class="iconbtn icon-calc" title="Calculadora">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="4" y="3" width="16" height="18" rx="2" stroke="#0b2555" stroke-width="2" fill="#dbeafe"/><rect x="7" y="6" width="10" height="3" rx="1" fill="#0b2555"/><path d="M8 12h2M8 16h2M12 12h2M12 16h2M16 12h2M16 16h2" stroke="#0b2555" stroke-width="2"/></svg>
        </button>
      </div>
      <img class="logo right-img" src="HDS.png" onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/HDS.png';" alt="HDS TEC">
    </div>

    <!-- Widgets -->
    <div id="noteWrap" class="widget note" style="position:fixed;right:18px;top:84px;z-index:50;display:none;width:240px;background:#fff3b0;border:1px solid #f5d565;border-radius:12px;box-shadow:0 14px 30px #0001;padding:10px">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px"><b>Post-it</b>
        <div class="row" style="gap:6px"><button id="clearNote" type="button" class="btn btn-plain" style="padding:4px 8px">Limpar</button><button id="closeNote" type="button" class="btn btn-plain" style="padding:4px 8px">Fechar</button></div>
      </div>
      <textarea id="noteArea" placeholder="Anote algo..." style="width:100%;height:120px;border:0;background:transparent;outline:none;font:14px/1.45 ui-sans-serif"></textarea>
    </div>

    <div id="calcWrap" class="widget calc" style="position:fixed;right:18px;top:84px;z-index:50;display:none;width:260px;background:#fff;border:1px solid #dbe0ea;border-radius:12px;box-shadow:0 14px 30px #0001;padding:12px">
      <div class="row" style="justify-content:space-between;margin-bottom:6px"><b>Calculadora</b><button id="closeCalc" type="button" class="btn btn-plain" style="padding:4px 8px">Fechar</button></div>
      <div class="screen" id="scr" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-weight:700;margin-bottom:10px;background:#f9fbff">0</div>
      <div class="keys" id="keys" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
        <div class="key op" data-k="C">C</div><div class="key op" data-k="±">±</div><div class="key op" data-k="%">%</div><div class="key op" data-k="/">÷</div>
        <div class="key" data-k="7">7</div><div class="key" data-k="8">8</div><div class="key" data-k="9">9</div><div class="key op" data-k="*">×</div>
        <div class="key" data-k="4">4</div><div class="key" data-k="5">5</div><div class="key" data-k="6">6</div><div class="key op" data-k="-">−</div>
        <div class="key" data-k="1">1</div><div class="key" data-k="2">2</div><div class="key" data-k="3">3</div><div class="key op" data-k="+">+</div>
        <div class="key" data-k="0">0</div><div class="key" data-k="00">00</div><div class="key" data-k=".">.</div><div class="key eq" data-k="=">=</div>
      </div>
      <style>.key{padding:10px;border-radius:10px;border:1px solid #e6e9f2;background:#f7f8fd;cursor:pointer;text-align:center;font-weight:800}.key.op{background:#eef6ff;border-color:#cfe7ff}.key.eq{background:linear-gradient(135deg,var(--lime),var(--lime2));color:#053}</style>
    </div>

    <!-- GRID -->
    <div class="grid">
      <!-- ALERTA -->
      <section class="card">
        <div class="tag">ALERTA</div>
        <h2>Controle de alerta</h2>
        <div class="row"><button id="btnAlert" type="button" class="btn btn-search">Pesquisar</button></div>
        <div class="hint" id="alertBusy" style="display:none"><div class="busy"><div class="spinner"></div><div>Pesquisando alerta...</div></div><div class="bar" style="margin-top:6px"></div></div>
        <div id="alertBox" class="out out-alert" style="display:none"><div id="alertMsg">—</div><div id="alertResp" class="hint">—</div></div>
      </section>

      <!-- SITES OFICIAIS (resposta + lista de PDFs do repo) -->
      <section class="card">
        <div class="tag">SITES OFICIAIS</div>
        <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
        <div class="row" style="margin-top:6px">
          <input id="qSites" class="input" placeholder="Digite sua pergunta .....">
          <button id="btnSites" type="button" class="btn btn-search">Pesquisar</button>
        </div>
        <div class="hint" id="sitesBusy" style="display:none"><div class="busy"><div class="spinner"></div><div>Pesquisando...</div></div><div class="bar" style="margin-top:6px"></div></div>
        <div id="outSites" class="out">—</div>
      </section>

      <!-- SLOT LIVRE -->
      <section class="free-card"><div class="free-pad">
        <img class="rr-img" src="rr.png" onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/rr.png';" alt="Mascote RIC acenando">
      </div></section>

      <!-- CRION -->
      <section class="card">
        <div class="tag">PROCEDIMENTOS CRION</div>
        <h2>Procedimentos</h2>
        <p class="hint">Material de Treinamento, Quiz, Alertas &gt; 30 dias e demais informações.</p>
        <div class="row">
          <input id="qCRION" class="input" placeholder="Ex.: Onboarding, Retenção, URA, Script de Cobrança, Affix">
          <button id="btnCRION" type="button" class="btn btn-search" style="min-width:112px">Pesquisar</button>
          <button id="btnReIdxCRION" type="button" class="btn btn-danger btn-reindex" style="min-width:112px; display:none">Reindexar</button>
        </div>
        <div class="hint" id="crionBusy" style="display:none"><div class="busy"><div class="spinner"></div><div>Listando procedimentos...</div></div><div class="bar" style="margin-top:6px"></div></div>
        <div class="out" id="crionBox"><div id="crionStatus" class="hint" style="margin-top:0">—</div><ul id="crionList" class="list"></ul></div>
      </section>
    </div>

    <footer>
      <span class="copyright">© 2025 Copyright: HDSTEC. Todos os Direitos Reservados v3.0.0 -Operacao</span>
      <span class="credit">desenvolvido por Alexandre Cavalcante</span>
    </footer>
  </div>

<script>
/* ======= CONFIG GAS ======= */
const APP_URL = "https://script.google.com/macros/s/AKfycbxnTEhSw1u5Ib0jCqJsURoZM30VfCpfeqKqKvYpXdKgJDUPrw8Q8hScbSzw4zVkI7u0rw/exec";

/* ======= HELPERS ======= */
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const show = (el, on=true)=>{ if(!el) return; el.style.display = on? "" : "none"; };
const esc  = s => String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
const cleanName = n => String(n||'').replace(/^(OCR_TMP_|TMP_SLIDES_)+/ig,'');
const link = (url, txt) => `<a href="${url}" target="_blank" rel="noopener">${esc(txt||url)}</a>`;
function humanSize(b){ if(!b||b<=0) return "—"; const u=["B","KB","MB","GB"]; let i=0; while(b>=1024&&i<u.length-1){ b/=1024; i++; } return b.toFixed(1)+" "+u[i]; }

/* ======= CHAMADAS GAS ======= */
function call(endpoint, payload){
  const url = APP_URL + "?fn=" + encodeURIComponent(endpoint);
  return fetch(url, { method:"POST", headers:{ "Content-Type":"text/plain" }, body: JSON.stringify(payload || {}) })
         .then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); });
}

/* ======= GITHUB RAW/CONTENTS ======= */
const GH_OWNER = "HD-TECH-hash";
const GH_REPO  = "Ricai-crion-operacao";
const RAW_BASE = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/main`;
async function listRawPdfs() {
  const api = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/data/affix/raw?ref=main`;
  const r = await fetch(api, {cache:'no-store'});
  if(!r.ok) throw new Error("Falha GitHub API");
  const arr = await r.json();
  return arr.filter(it => it.type === "file" && /\.pdf$/i.test(it.name));
}
async function exists(url){
  try{ const r = await fetch(url, {method:'HEAD', cache:'no-store'}); return r.ok; }
  catch(e){ return false; }
}

/* ======= APP ======= */
document.addEventListener('DOMContentLoaded', () => {
  // Post-it
  const noteWrap = $('#noteWrap'), noteArea = $('#noteArea');
  $('#toggleNote')?.addEventListener('click', ()=>{ const on = noteWrap.style.display !== "block"; noteWrap.style.display = on? "block" : ""; if(on) noteArea.focus(); });
  $('#clearNote')?.addEventListener('click', ()=>{ noteArea.value=""; localStorage.removeItem('ric_note'); });
  $('#closeNote')?.addEventListener('click', ()=>{ noteWrap.style.display="none"; });
  noteArea.value = localStorage.getItem('ric_note') || "";
  noteArea.addEventListener('input', ()=> localStorage.setItem('ric_note', noteArea.value));

  // Calc
  $('#toggleCalc')?.addEventListener('click', ()=>{ $('#calcWrap').style.display = $('#calcWrap').style.display? "" : "block"; });
  $('#closeCalc')?.addEventListener('click', ()=>{ $('#calcWrap').style.display="none"; });
  const scr = $('#scr'); const calc = { buf:"0", op:null, mem:0, fresh:true };
  function refresh(){ scr.textContent = calc.buf; }
  function press(k){
    if(/\d/.test(k)){ calc.buf = (calc.fresh||calc.buf==="0")? k : calc.buf+k; calc.fresh=false; return refresh(); }
    if(k==="00"){ press("0"); return press("0"); }
    if(k==="."){ if(!calc.buf.includes(".")) calc.buf += "."; calc.fresh=false; return refresh(); }
    if(k==="C"){ calc.buf="0"; calc.op=null; calc.fresh=true; return refresh(); }
    if(k==="±"){ if(calc.buf!=="0") calc.buf = calc.buf.startsWith("-")? calc.buf.slice(1):"-"+calc.buf; return refresh(); }
    if(k==="%"){ calc.buf = String(parseFloat(calc.buf)/100); return refresh(); }
    if("+-*/".includes(k)){ calc.mem=parseFloat(calc.buf); calc.op=k; calc.fresh=true; return; }
    if(k==="=" && calc.op){ const a=calc.mem, b=parseFloat(calc.buf); let v=0; switch(calc.op){case "+":v=a+b;break;case "-":v=a-b;break;case "*":v=a*b;break;case "/":v=b===0? "Erro" : a/b;break;} calc.buf=String(v); calc.op=null; calc.fresh=true; return refresh(); }
  }
  $('#keys')?.addEventListener('click', e=>{ const k=e.target?.dataset?.k; if(k) press(k); });

  // ALERTA
  $('#btnAlert')?.addEventListener('click', async ()=>{
    const box=$('#alertBox'), msg=$('#alertMsg'), resp=$('#alertResp');
    show(box,false); show($('#alertBusy'),true);
    try{
      const r = await call('getalert',{});
      if(!r || r.ok===false){ msg.textContent="Falha ao consultar."; resp.textContent=""; show(box,true); return; }
      if(!r.found){ msg.textContent="Sem recado no momento."; resp.textContent=""; show(box,true); return; }
      msg.textContent = "🚨 " + String(r.mensagem||"—").toUpperCase();
      resp.textContent = r.responsavel ? String(r.responsavel||"").toLowerCase() : "";
      show(box,true);
    }catch(e){ msg.textContent="Erro: "+e.message; resp.textContent=""; show(box,true);
    }finally{ show($('#alertBusy'),false); }
  });

  // SITES OFICIAIS — responde (GAS) + lista PDFs do repo
  $('#btnSites')?.addEventListener('click', doSites);
  $('#qSites')?.addEventListener('keydown', e=>{ if(e.key==='Enter') doSites(); });
  async function doSites(){
    const q=($('#qSites').value||'').trim();
    show($('#sitesBusy'),true);
    const container = $('#outSites');
    container.innerHTML = '<div id="sitesAnswer"></div><div id="sitesList" style="margin-top:8px"></div>';
    const ans = $('#sitesAnswer'); const list = $('#sitesList');

    // 1) Resposta “lê o site”
    try{
      const qRich = q ? (q + " — FORMATO: responda em português e liste urls oficiais no final. Use: 'Fontes oficiais Affix, Alter, Hapvida'.") : "Quais são os manuais e links úteis da Affix?";
      const r = await call('chat',{q:qRich});
      const txt = (r && r.text) ? r.text : '—';
      const html = String(txt).replace(/(https?:\/\/[^\s]+)/g, m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
      ans.innerHTML = html;
    }catch(e){ ans.textContent = 'Erro na resposta: '+e.message; }

    // 2) Lista dos PDFs do repo (filtro por q)
    try{
      const items = await listRawPdfs();
      const filtered = items.filter(it => it.name.toLowerCase().includes(q.toLowerCase()));
      const total = filtered.length;
      const frag = document.createDocumentFragment();
      const metaBar = document.createElement('div');
      metaBar.className='hint';
      metaBar.textContent = `Manuais no repositório: ${total} ${q ? "• filtro: “"+q+"”":""}`;
      frag.appendChild(metaBar);

      for (const it of filtered){
        const name = it.name;
        const openUrl = it.download_url;
        const base = name.replace(/\.pdf$/i,'');
        const thumbUrl = `${RAW_BASE}/data/affix/ocr/${encodeURIComponent(base)}/thumb.png`;
        const textUrl  = `${RAW_BASE}/data/affix/ocr/${encodeURIComponent(base)}/text.txt`;

        const [hasThumb, hasText] = await Promise.all([exists(thumbUrl), exists(textUrl)]);

        const wrap = document.createElement('div'); wrap.className='item';
        const head = document.createElement('div'); head.className='file-head';

        if(hasThumb){ const img=document.createElement('img'); img.className='thumb'; img.src=thumbUrl; img.alt='Thumb'; head.appendChild(img); }
        const title = document.createElement('div'); title.innerHTML = `<b>${esc(name)}</b>`; head.appendChild(title);
        wrap.appendChild(head);

        const actions = document.createElement('div'); actions.className='file-actions';

        const aOpen = document.createElement('a'); aOpen.className='btn btn-plain btn-sm'; aOpen.href=openUrl; aOpen.target='_blank'; aOpen.rel='noopener'; aOpen.textContent='Abrir'; actions.appendChild(aOpen);

        const btnPrev = document.createElement('button'); btnPrev.className='btn btn-plain btn-sm'; btnPrev.textContent='Prévia';
        btnPrev.addEventListener('click', ()=>{
          const id = 'prev_'+btoa(name).replace(/=+/g,''); let prev = document.getElementById(id);
          if(prev){ prev.remove(); return; }
          prev = document.createElement('div'); prev.id=id; prev.style.marginTop='8px';
          prev.innerHTML = `<embed src="${openUrl}#toolbar=1" type="application/pdf" style="width:100%;height:420px;border:1px solid var(--line);border-radius:10px">`;
          wrap.appendChild(prev);
        });
        actions.appendChild(btnPrev);

        if(hasText){
          const btnOCR = document.createElement('button'); btnOCR.className='btn btn-plain btn-sm'; btnOCR.textContent='Ver texto (OCR)';
          btnOCR.addEventListener('click', async ()=>{
            const id = 'ocr_'+btoa(name).replace(/=+/g,''); let box = document.getElementById(id);
            if(box){ box.remove(); return; }
            box = document.createElement('div'); box.id=id; box.className='out'; box.textContent='Carregando OCR…'; wrap.appendChild(box);
            try{ const r = await fetch(textUrl, {cache:'no-store'}); box.textContent = r.ok ? await r.text() : 'OCR não disponível.'; }
            catch(e){ box.textContent = 'Erro ao carregar OCR.'; }
          });
          actions.appendChild(btnOCR);
        }

        const meta = document.createElement('div'); meta.className='hint'; meta.textContent = `Tamanho: ${humanSize(it.size||0)}`;
        wrap.appendChild(actions); wrap.appendChild(meta); frag.appendChild(wrap);
      }

      list.innerHTML = ''; list.appendChild(frag);
    }catch(e){ $('#outSites').textContent = 'Erro: '+e.message; }
    finally{ show($('#sitesBusy'),false); }
  }

  // CRION (GAS)
  $('#btnCRION')?.addEventListener('click', doCRION);
  $('#qCRION')?.addEventListener('keydown', e=>{ if(e.key==='Enter') doCRION(); });
  $('#btnReIdxCRION')?.addEventListener('click', async ()=>{ $('#crionStatus').textContent='Reindexando CRION…'; show($('#crionBusy'),true);
    try{ const r=await call('reindexcrion',{}); $('#crionStatus').textContent="Index CRION: "+(r && r.ok ? "OK" : "Falhou"); }
    catch(e){ $('#crionStatus').textContent='Erro: '+e.message; }
    finally{ show($('#crionBusy'),false); }
  });
  async function doCRION(){
    const q=($('#qCRION').value||'').trim();
    if(!q){ $('#crionStatus').textContent='Digite um termo.'; return; }
    show($('#crionBusy'),true); $('#crionStatus').textContent='Listando arquivos…'; $('#crionList').innerHTML="";
    try{
      const res = await call('searchcrion',{q});
      if(!res || res.ok===false){ $('#crionStatus').textContent='Erro ao buscar: '+(res&&res.message?res.message:''); return; }
      const items=res.items||[]; $('#crionStatus').textContent=`Resultados: ${items.length}`;
      const frag=document.createDocumentFragment();
      items.forEach((it,idx)=>{
        const li=document.createElement('li'); li.className='item'; li.id='crion_'+idx;
        const meta  = `<div class="hint">Tamanho: ${humanSize(it.size||0)} • Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "—"}</div>`;
        li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> • ${link(it.url,'Abrir')}</div>${meta}<div class="hint" id="snip_crion_${idx}">Carregando prévias…</div>`;
        frag.appendChild(li);
      });
      $('#crionList').appendChild(frag);
      if(items.length){
        let from=0;
        while(from < items.length){
          const r = await call('fetchcrionsnippets',{sessionId:res.sessionId, from, limit:6});
          (r.items||[]).forEach(row=>{
            const el=$('#snip_crion_'+row.index);
            el.innerHTML=(row.snippets && row.snippets.length)? row.snippets.map(s=>`<div class="snip">${esc(s)}</div>`).join("") : '<span class="hint">—</span>';
          });
          from = r.to;
        }
        $('#crionStatus').textContent += " • prévias completas";
      }
    }catch(e){ $('#crionStatus').textContent='Erro: '+e.message; }
    finally{ show($('#crionBusy'),false); }
  }
});
</script>
</body>
</html>

<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RIC AI ‚Äî CRION</title>

<style>
  :root{
    /* Paleta pedida anteriormente */
    --alert:#fe0000;
    --postit:#fddb56;
    --calc:#5fa5fa;
    --sites:#0001fc;
    --procs:#fe6700;
    --search:#31a59c;
    --shadow:#50d9cd;

    --ink:#0f172a; --muted:#64748b; --line:#e7eef7;
    --bg-solid:#4889c5; /* Fundo principal */
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font:14px/1.55 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    /* Fundo azul com leve vinheta */
    background:
      radial-gradient(900px 420px at 30% -200px, #ffffff70 0%, #ffffff00 60%),
      radial-gradient(900px 420px at 85% -220px, #ffffff50 0%, #ffffff00 65%),
      var(--bg-solid);
  }

  /* ========== TOPO / MARCAS (flutuantes, mas alinhadas visualmente √†s caixas) ========== */
  .topbar {
    position: sticky; top: 0; z-index: 40;
    padding: 12px 16px 0 16px;
  }
  .brandrow{
    max-width:1260px; margin:0 auto; display:grid; grid-template-columns:1fr auto; align-items:center;
  }
  .logo-crion { height:44px; object-fit:contain; }
  .righttools { display:flex; gap:10px; align-items:center; }
  .tool{
    width:40px;height:40px;border-radius:12px;border:1px solid #ffffff60;
    display:grid;place-items:center; backdrop-filter:blur(3px);
    box-shadow:0 10px 22px #0002; cursor:pointer; transition:.15s;
  }
  .tool:hover{transform:translateY(-1px)}
  .tool-note{background:var(--postit)}
  .tool-calc{background:var(--calc)}
  .logo-hds { height:44px; object-fit:contain; filter:drop-shadow(0 2px 6px #0002) }

  /* ========== LAYOUT ========== */
  .wrap{max-width:1260px;margin:0 auto;padding:0 16px 24px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:8px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .card{
    position:relative;
    background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;
    box-shadow:0 18px 36px rgba(80,217,205,.18), 0 8px 24px rgba(80,217,205,.14);
  }
  .tag{
    display:inline-flex;align-items:center;gap:8px;
    color:#fff;border-radius:999px;padding:6px 12px;font-weight:900;font-size:12px;
    text-transform:uppercase; letter-spacing:.3px;
    box-shadow:0 10px 22px #0001;
  }
  .tag.alertas{background:var(--alert)}
  .tag.sites{background:var(--sites)}
  .tag.procs{background:var(--procs)}
  h2{margin:8px 0 10px;font-size:18px}

  .row{display:flex;gap:10px;align-items:center}
  .input{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:#fbfcff}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer}
  .btn-search{background:var(--search); color:#053; box-shadow:0 10px 22px rgba(49,165,156,.28)}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}

  .out{
    white-space:pre-wrap;min-height:120px;border:1px dashed var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#fbfbff
  }

  /* √Årea de resultados locais (PDFs) */
  .pdf-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:10px}
  .pdf-list{margin:8px 0 0;padding:0;list-style:none}
  .pdf-item{border-top:1px solid var(--line);padding:10px 0}
  .pdf-actions{display:flex;gap:8px;align-items:center;margin-top:6px}
  .pill{font-size:11px;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#f9fafb;color:#334155}

  /* Pr√©via (PDF.js) embutida */
  .preview{margin-top:8px;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
  .preview iframe{width:100%;height:520px;border:0;display:block;background:#f8fafc}

  /* √çcones alinhados √† caixa ‚ÄúSites‚Äù */
  .sites-tools{
    position:absolute; right:12px; top:12px; display:flex; gap:8px; z-index:1;
  }

  /* Widgets Post-it / Calculadora */
  .widget{position:fixed;right:18px;z-index:60;display:none;border-radius:12px;box-shadow:0 14px 30px #0001}
  #noteWrap{top:84px;width:260px;background:#fff3b0;border:1px solid #f5d565;padding:10px}
  #calcWrap{top:260px;width:270px;background:#fff;border:1px solid #dbe0ea;padding:12px}
  .key{padding:10px;border-radius:10px;border:1px solid #e6e9f2;background:#f7f8fd;cursor:pointer;text-align:center;font-weight:800}
  .key.op{background:#eef6ff;border-color:#cfe7ff}
  .key.eq{background:linear-gradient(135deg,#22c55e,#a3e635);color:#053}

  footer{margin:18px 0 6px;text-align:center}
  .copyright{font-size:12px;color:#164e63}
</style>
</head>
<body>

  <!-- TOPO / MARCAS -->
  <div class="topbar">
    <div class="brandrow">
      <img class="logo-crion" src="https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/icon2.png" alt="CRION">
      <div class="righttools">
        <button id="toggleNote" class="tool tool-note" title="Post-it">üìù</button>
        <button id="toggleCalc" class="tool tool-calc" title="Calculadora">üßÆ</button>
        <img class="logo-hds" src="https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/HDS.png" alt="HDSTEC">
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- ALERTA -->
      <section class="card" id="cardAlert">
        <div class="tag alertas">Alertas</div>
        <h2>Controle de alerta</h2>
        <div class="row">
          <button id="btnAlert" class="btn btn-search">Pesquisar</button>
        </div>
        <div class="hint" id="alertBusy" style="display:none">Consultando‚Ä¶</div>
        <div id="alertBox" class="out" style="display:none">
          <div id="alertMsg" style="font-size:22px;font-weight:900;color:#b91c1c">‚Äî</div>
          <div id="alertResp" class="hint">‚Äî</div>
        </div>
        <div class="hint" id="alertNeedGas" style="display:none;color:#b91c1c;font-weight:800">
          Este recurso depende do Google Apps Script.
        </div>
      </section>

      <!-- SITES -->
      <section class="card" id="cardSites">
        <div class="tag sites">Sites</div>
        <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>

        <!-- √çcones dentro da caixa (alinhados) -->
        <div class="sites-tools">
          <button class="tool tool-note" title="Post-it" id="toggleNote2">üìù</button>
          <button class="tool tool-calc" title="Calculadora" id="toggleCalc2">üßÆ</button>
        </div>

        <div class="row" style="margin-top:6px">
          <input id="qSites" class="input" placeholder="Digite: ex. manual, estado (SP), 2024 ‚Ä¶">
          <button id="btnSites" class="btn btn-search">Pesquisar</button>
        </div>

        <!-- Sa√≠da ‚ÄúIA‚Äù opcional (GAS) -->
        <div class="hint" id="sitesBusy" style="display:none">Pesquisando‚Ä¶</div>
        <div id="outSitesIa" class="out" style="display:none"></div>
        <div class="hint" id="sitesNeedGas" style="display:none;color:#b45309;font-weight:700">
          Dica: recursos de IA/alerta/CRION exigem abrir esta p√°gina via Web App do Google Apps Script.
        </div>

        <!-- PDFs locais -->
        <div class="pdf-head">
          <div class="hint" style="margin:0"><b>PDFs (Affix ‚Äî √≠ndice local)</b></div>
          <div class="pill"><span id="pdfCount">0</span> resultado(s)</div>
        </div>
        <ul id="pdfList" class="pdf-list"></ul>
      </section>

      <!-- RR (mascote) -->
      <div class="card" style="display:grid;place-items:center;padding:0;background:transparent;border:0;box-shadow:none">
        <img src="https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/rr.png" alt="Ol√°, meu nome √© RIC. Precisa de uma ajuda?" style="max-width:420px;width:100%;height:auto;filter:drop-shadow(0 20px 40px rgba(80,217,205,.24))">
      </div>

      <!-- PROCEDIMENTOS (opcional via GAS) -->
      <section class="card">
        <div class="tag procs">Procedimentos</div>
        <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
        <div class="row">
          <input id="qCRION" class="input" placeholder="Digite sua pergunta ‚Ä¶..">
          <button id="btnCRION" class="btn btn-search">Pesquisar</button>
        </div>
        <div class="hint" id="crionBusy" style="display:none">Listando‚Ä¶</div>
        <div id="crionNeedGas" class="hint" style="display:none;color:#b91c1c;font-weight:800">
          Este recurso depende do Google Apps Script.
        </div>
        <div class="out" id="crionBox" style="display:none">
          <div id="crionStatus" class="hint" style="margin-top:0">‚Äî</div>
          <ul id="crionList" style="margin:8px 0 0;padding:0;list-style:none"></ul>
        </div>
      </section>
    </div>

    <footer>
      <div class="copyright">Desenvolvido por Alexandre Cavalcante V3.0-Operacao</div>
    </footer>
  </div>

  <!-- Widgets -->
  <div id="noteWrap" class="widget">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <b>Post-it</b>
      <div style="display:flex;gap:6px">
        <button id="clearNote" class="btn" style="background:#fff;border:1px solid #f5d565">Limpar</button>
        <button id="closeNote" class="btn" style="background:#fff;border:1px solid #f5d565">Fechar</button>
      </div>
    </div>
    <textarea id="noteArea" placeholder="Anote algo..." style="width:100%;height:120px;border:0;background:transparent;outline:none;font:14px/1.45 ui-sans-serif"></textarea>
  </div>

  <div id="calcWrap" class="widget">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <b>Calculadora</b>
      <button id="closeCalc" class="btn" style="background:#fff;border:1px solid #dbe0ea">Fechar</button>
    </div>
    <div class="screen" id="scr" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-weight:700;margin-bottom:10px;background:#f9fbff">0</div>
    <div class="keys" id="keys" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
      <div class="key op" data-k="C">C</div>
      <div class="key op" data-k="¬±">¬±</div>
      <div class="key op" data-k="%">%</div>
      <div class="key op" data-k="/">√∑</div>
      <div class="key" data-k="7">7</div><div class="key" data-k="8">8</div><div class="key" data-k="9">9</div><div class="key op" data-k="*">√ó</div>
      <div class="key" data-k="4">4</div><div class="key" data-k="5">5</div><div class="key" data-k="6">6</div><div class="key op" data-k="-">‚àí</div>
      <div class="key" data-k="1">1</div><div class="key" data-k="2">2</div><div class="key" data-k="3">3</div><div class="key op" data-k="+">+</div>
      <div class="key" data-k="0">0</div><div class="key" data-k="00">00</div><div class="key" data-k=".">.</div><div class="key eq" data-k="=">=</div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
/* Se quiser ativar chamadas ao seu GAS, coloque aqui a URL do Web App (exec):
   Ex.: const APP_URL = "https://script.google.com/macros/s/AKfycb.../exec";
   Se deixar vazio, mostramos a mensagem ‚Äúdepende do GAS‚Äù e seguimos s√≥ com PDFs locais. */
const APP_URL = "";

/* Caminho do manifesto local gerado pelo cron */
const MANIFEST_URL = "data/affix/manifest.json"; // j√° existe no seu repo

/* ================== HELPERS ================== */
const $ = s => document.querySelector(s);
const show = (el,on=true)=>{ if(!el) return; el.style.display = on? "" : "none"; };
function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function humanSize(b){ if(!b||b<=0) return "‚Äî"; const u=["B","KB","MB","GB"]; let i=0; while(b>=1024&&i<u.length-1){ b/=1024; i++; } return b.toFixed(1)+" "+u[i]; }
const delay = ms => new Promise(r=>setTimeout(r,ms));

/* GAS via fetch (opcional) */
async function gas(endpoint, payload){
  if(!APP_URL) throw new Error("NO_GAS");
  const url = APP_URL + "?fn=" + encodeURIComponent(endpoint);
  const r = await fetch(url,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(payload||{})});
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}

/* ================== WIDGETS ================== */
const noteWrap=$('#noteWrap'), noteArea=$('#noteArea');
function toggleNote(){ noteWrap.style.display = noteWrap.style.display ? "" : "block"; if(noteWrap.style.display) noteArea.focus(); }
$('#toggleNote').onclick=toggleNote; $('#toggleNote2').onclick=toggleNote;
$('#clearNote').onclick=()=>{ noteArea.value=""; localStorage.removeItem('ric_note'); };
$('#closeNote').onclick=()=>{ noteWrap.style.display="none"; };
noteArea.value = localStorage.getItem('ric_note') || "";
noteArea.addEventListener('input', ()=> localStorage.setItem('ric_note', noteArea.value));

const calc = { buf:"0", op:null, mem:0, fresh:true };
function refresh(){ $('#scr').textContent = calc.buf; }
function press(k){
  if(/\d/.test(k)){ calc.buf = (calc.fresh||calc.buf==="0")? k : calc.buf+k; calc.fresh=false; return refresh(); }
  if(k==="00"){ press("0"); press("0"); return; }
  if(k==="."){ if(!calc.buf.includes(".")) calc.buf += "."; calc.fresh=false; return refresh(); }
  if(k==="C"){ calc.buf="0"; calc.op=null; calc.fresh=true; return refresh(); }
  if(k==="¬±"){ if(calc.buf!=="0") calc.buf = calc.buf.startsWith("-")? calc.buf.slice(1):"-"+calc.buf; return refresh(); }
  if(k==="%"){ calc.buf = String(parseFloat(calc.buf)/100); return refresh(); }
  if("+-*/".includes(k)){ calc.mem=parseFloat(calc.buf); calc.op=k; calc.fresh=true; return; }
  if(k==="=" && calc.op){ const a=calc.mem, b=parseFloat(calc.buf);
    let v=0; switch(calc.op){case "+":v=a+b;break;case "-":v=a-b;break;case "*":v=a*b;break;case "/":v=b===0? "Erro" : a/b;break;}
    calc.buf=String(v); calc.op=null; calc.fresh=true; return refresh();
  }
}
$('#keys').addEventListener('click', e=>{ const k=e.target.dataset.k; if(k) press(k); });
function toggleCalc(){ $('#calcWrap').style.display = $('#calcWrap').style.display? "" : "block"; refresh(); }
$('#toggleCalc').onclick=toggleCalc; $('#toggleCalc2').onclick=toggleCalc; $('#closeCalc').onclick=()=>$('#calcWrap').style.display="none";

/* ================== ALERTA (opcional) ================== */
$('#btnAlert').addEventListener('click', async ()=>{
  show($('#alertNeedGas'), !APP_URL);
  if(!APP_URL) return;

  show($('#alertBusy'),true); show($('#alertBox'),false);
  try{
    const r = await gas('getalert',{});
    const msg = $('#alertMsg'), resp=$('#alertResp');
    if(!r || r.ok===false){ msg.textContent="Falha ao consultar."; resp.textContent=""; }
    else if(!r.found){ msg.textContent="Sem recado no momento."; resp.textContent=""; }
    else {
      msg.textContent="üö® " + String(r.mensagem||"‚Äî").toUpperCase();
      resp.textContent = r.responsavel ? String(r.responsavel).toLowerCase() : "";
    }
    show($('#alertBox'),true);
  }catch(e){
    $('#alertMsg').textContent="Erro: "+(e.message||e); show($('#alertBox'),true);
  }finally{ show($('#alertBusy'),false); }
});

/* ================== SITES ================== */
/* 1) IA opcional via GAS   2) PDF local (manifest) incremental com Pr√©via (PDF.js) */
let MANIFEST = null;

async function loadManifestOnce(){
  if(MANIFEST) return MANIFEST;
  const r = await fetch(MANIFEST_URL, {cache:"no-store"});
  if(!r.ok) throw new Error("Manifesto n√£o encontrado");
  MANIFEST = await r.json(); // formato [{name,url,year,state,source}, ...]
  return MANIFEST;
}

/* Render de um item de PDF */
function renderPdfItem(it, idx){
  const li = document.createElement('li');
  li.className = 'pdf-item';
  li.innerHTML = `
    <div><b>${esc(it.name)}</b></div>
    <div class="hint">
      ${it.year ? `Ano: ${esc(it.year)} ‚Ä¢ ` : ""}${it.state ? `UF: ${esc(it.state)} ‚Ä¢ `: ""}
      <span class="pill">${esc(new URL(it.url).hostname)}</span>
    </div>
    <div class="pdf-actions">
      <a class="btn" style="background:#eef2ff;border:1px solid #dbeafe" target="_blank" rel="noopener" href="${it.url}">Abrir</a>
      <button class="btn" data-prev="p${idx}" style="background:#f1f5f9;border:1px solid #e2e8f0">Pr√©via</button>
    </div>
    <div id="p${idx}" class="preview" style="display:none">
      <iframe title="Pr√©via PDF"></iframe>
    </div>
  `;
  li.querySelector('button[data-prev]').addEventListener('click',()=>{
    const pid = 'p'+idx;
    const box = document.getElementById(pid);
    const ifr = box.querySelector('iframe');
    if(box.style.display){ // abrir
      const viewer = "https://mozilla.github.io/pdf.js/web/viewer.html?file=" + encodeURIComponent(it.url);
      ifr.src = viewer; // PDF.js (zoom, busca, thumbs‚Ä¶)
      box.style.display="";
    }else{
      box.style.display="none"; ifr.removeAttribute('src');
    }
  });
  return li;
}

async function doSites(){
  const q = ($('#qSites').value||'').trim();
  if(!q){ $('#outSitesIa').textContent='Digite a pergunta.'; show($('#outSitesIa'),true); return; }

  // IA (opcional via GAS)
  show($('#sitesNeedGas'), !APP_URL);
  if(APP_URL){
    show($('#sitesBusy'),true); show($('#outSitesIa'),false);
    try{
      const qRich = q + " ‚Äî FORMATO: responda em portugu√™s; liste URLs oficiais no final. Substitua observa√ß√µes por: 'Fontes oficiais Affix, Alter, Hapvida'.";
      const r = await gas('chat',{q:qRich});
      const txt = (r && r.text) ? r.text : '‚Äî';
      const html = String(txt).replace(/(https?:\/\/[^\s]+)/g, m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
      $('#outSitesIa').innerHTML = html;
      show($('#outSitesIa'),true);
    }catch(e){
      $('#outSitesIa').textContent='Erro IA: '+(e.message||e);
      show($('#outSitesIa'),true);
    }finally{ show($('#sitesBusy'),false); }
  }

  // PDFs locais (incremental)
  const list = $('#pdfList'); list.innerHTML=""; $('#pdfCount').textContent='0';
  let count=0;
  try{
    const data = await loadManifestOnce();
    // filtro simples: todos os termos (case-insensitive) precisam aparecer em name ou url/ano/uf
    const terms = q.toLowerCase().split(/\s+/).filter(Boolean);
    const matches = data.filter(it=>{
      const blob = [it.name,it.url,it.year,it.state].map(v=>String(v||'').toLowerCase()).join(' ');
      return terms.every(t=>blob.includes(t));
    });

    // stream incremental
    for(let i=0;i<matches.length;i++){
      const it = matches[i];
      list.appendChild(renderPdfItem(it, i));
      count++; $('#pdfCount').textContent = String(count);
      if(i%5===0) await delay(20); // respiro pro render
    }
    if(count===0){
      const li=document.createElement('li'); li.className='pdf-item';
      li.innerHTML='<div class="hint">Nenhum PDF local encontrado.</div>';
      list.appendChild(li);
    }
  }catch(e){
    const li=document.createElement('li'); li.className='pdf-item';
    li.innerHTML='<div class="hint" style="color:#b91c1c">Falha ao ler manifest: '+esc(e.message||e)+'</div>';
    list.appendChild(li);
  }
}
$('#btnSites').addEventListener('click', doSites);
$('#qSites').addEventListener('keydown', e=>{ if(e.key==='Enter') doSites(); });

/* ================== CRION (opcional via GAS) ================== */
$('#btnCRION').addEventListener('click', async ()=>{
  show($('#crionNeedGas'), !APP_URL);
  if(!APP_URL) return;

  const q = ($('#qCRION').value||'').trim();
  if(!q){ $('#crionStatus').textContent='Digite um termo.'; show($('#crionBox'),true); return; }
  show($('#crionBusy'),true); $('#crionStatus').textContent='Listando arquivos‚Ä¶'; $('#crionList').innerHTML="";
  try{
    const res = await gas('searchcrion',{q});
    if(!res || res.ok===false){ $('#crionStatus').textContent='Erro ao buscar: '+(res&&res.message?res.message:''); show($('#crionBox'),true); return; }
    const items=res.items||[]; $('#crionStatus').textContent=`Resultados: ${items.length}`;
    const frag=document.createDocumentFragment();
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.style.padding="10px 0"; li.style.borderTop="1px solid var(--line)";
      const meta  = `<div class="hint">Tamanho: ${humanSize(it.size||0)} ‚Ä¢ Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "‚Äî"}</div>`;
      li.innerHTML=`<div><b>${esc(it.name||'')}</b> ‚Ä¢ <a href="${it.url}" target="_blank" rel="noopener">Abrir</a></div>${meta}`;
      frag.appendChild(li);
    });
    $('#crionList').appendChild(frag);
    show($('#crionBox'),true);
  }catch(e){
    $('#crionStatus').textContent='Erro: '+(e.message||e); show($('#crionBox'),true);
  }finally{ show($('#crionBusy'),false); }
});
</script>
</body>
</html>

<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RIC AI â€” CRION</title>
<style>
Â  :root{
Â  Â  /* Paleta do seu cÃ³digo original */
Â  Â  --alert:#fe0000;
Â  Â  --sites:#0001fc;
Â  Â  --procs:#fe6700;
Â  Â  --search:#31a59c;
Â  Â  --shadow:#50d9cd;

Â  Â  --postit:#fddb56;
Â  Â  --calc:#5fa5fa;

Â  Â  --ink:#0f172a;
Â  Â  --muted:#64748b;
Â  Â  --line:#e7eef7;

Â  Â  /* Fundo do cÃ³digo original (cor Ãºnica) */
Â  Â  --bg1:#4889c5;
Â  Â  --bg2:#3f7eb9;

Â  Â  /* PDFs â€“ laranja bem clarinho */
Â  Â  --pdf-bg:#fff7ed;Â  Â 
Â  Â  --pdf-bd:#ffedd5;Â  Â 

Â  Â  /* Estilos do novo header (mantidos) */
Â  Â  --base-font:12px;
Â  Â  --brand:#2882bb; 
Â  Â  --brand2:#2a8fcf;
Â  Â  --bg:#f7f8fc; 
Â  Â  --ink:#0f172a; 
Â  Â  --muted:#667085; 
Â  Â  --line:#E7EAF3;
Â  Â  --lime:#22c55e; 
Â  Â  --lime2:#a3e635; 
Â  Â  --danger:#ef4444;
Â  Â  --tag:#F2E7FF; 
Â  Â  --tag-ink:#6D28D9; 
Â  Â  --tag-shadow:0 4px 10px rgba(40,130,187,.18);
Â  Â  --card-shadow:0 18px 36px rgba(99,102,241,.12), 0 8px 24px rgba(40,130,187,.10);
Â  }

Â  *{box-sizing:border-box}
Â  html,body{height:100%}
Â  body{
Â  Â  margin:0;color:var(--ink);
Â  Â  font:14px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
Â  Â  background: var(--bg1);
Â  }

Â  /* ====== HEADER (do segundo cÃ³digo) ====== */
Â  .hero{
Â  Â  display:flex; align-items:center; gap:12px;
Â  Â  border-radius:18px; padding:12px 16px; color:#fff;
Â  Â  background:linear-gradient(135deg,var(--brand),var(--brand2));
Â  Â  box-shadow:0 24px 56px rgba(40,130,187,.22);
Â  Â  min-height:78px;
Â  }
Â  .hero-left{display:flex; align-items:center; gap:10px}
Â  .hero-center{flex:1}Â  Â  Â  Â  Â  Â /* vazio por requisito */
Â  .hero-right{display:flex; align-items:center; gap:12px}

Â  .logo-left{height:44px; object-fit:contain; filter:drop-shadow(0 2px 6px #0002)}
Â  .logo-hds{height:44px; object-fit:contain; filter:drop-shadow(0 2px 6px #0002)}

Â  .iconbtn{
Â  Â  width:36px;height:36px;border-radius:12px;border:1px solid #ffffff40;
Â  Â  display:grid;place-items:center; cursor:pointer; backdrop-filter:blur(4px);
Â  Â  transition:.15s; box-shadow:0 6px 14px rgba(0,0,0,.15)
Â  }
Â  .iconbtn:hover{transform:translateY(-1px)}
Â  .icon-note{background:#ffd95e}
Â  .icon-calc{background:#60a5fa}
Â  .iconbtn svg{display:block}

Â  @media (max-width:980px){
Â  Â  .logo-left{height:34px}
Â  Â  .logo-hds{height:34px}
Â  Â  .iconbtn{width:34px;height:34px}
Â  }

Â  /* ===== CONTEÃšDO ===== */
Â  .wrap{max-width:1260px;margin:16px auto 24px;padding:0 16px}
Â  .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
Â  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

Â  .card{
Â  Â  background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;
Â  Â  box-shadow:0 18px 36px rgba(80,217,205,.18), 0 8px 24px rgba(80,217,205,.14);
Â  }
Â  h2{margin:8px 0 10px;font-size:18px}

Â  .tag{
Â  Â  display:inline-flex;align-items:center;gap:8px;
Â  Â  color:#fff;border-radius:999px;padding:6px 12px;font-weight:900;font-size:12px;
Â  Â  text-transform:uppercase; letter-spacing:.3px;
Â  Â  box-shadow:0 10px 22px #0001
Â  }
Â  .tag.alertas{background:var(--alert)}
Â  .tag.sites{background:var(--sites)}
Â  .tag.procs{background:var(--procs)}
Â  .tag.pdfs{background:#0ea5e9}

Â  .row{display:flex;gap:10px;align-items:center}
Â  .input{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:#fbfcff}
Â  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer}
Â  .btn-search{background:var(--search); color:#053; box-shadow:0 10px 22px rgba(49,165,156,.28)}
Â  .btn-plain{background:#f1f5f9;color:#0f172a;border:1px solid #e2e8f0}
Â  .hint{font-size:12px;color:var(--muted);margin-top:6px}
Â  .out{white-space:pre-wrap;min-height:120px;border:1px dashed var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#fbfbff}

Â  /* Lista/PrÃ©via de PDFs (laranja clarinho) */
Â  #affixList .affix-row{padding:8px 10px;border:1px solid var(--pdf-bd);background:var(--pdf-bg);border-radius:12px;margin:10px 0}
Â  #affixList .affix-actions{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
Â  #affixList .affix-prev{display:none;margin-top:8px;border-radius:10px;overflow:hidden;border:1px solid var(--pdf-bd);background:#fff}
Â  #affixList iframe{width:100%;height:520px;border:0;background:#fff}

Â  /* AnimaÃ§Ãµes â€œbolinhasâ€ */
Â  .busy{display:flex;align-items:center;gap:10px}
Â  .dots{display:inline-block;width:36px;height:10px;position:relative}
Â  .dots i{position:absolute;left:0;top:0;width:8px;height:8px;border-radius:50%;background:#94a3b8;animation:bounce 0.85s infinite}
Â  .dots i:nth-child(2){left:12px;animation-delay:.1s}
Â  .dots i:nth-child(3){left:24px;animation-delay:.2s}
Â  @keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}

Â  .bar{position:relative;height:6px;border-radius:999px;background:#e9e9ff;overflow:hidden}
Â  .bar:before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,#c7b8ff,#a78bfa,#93c5fd);animation:load 1.1s infinite}
Â  @keyframes load{0%{left:-100%;right:100%}50%{left:0;right:0}100%{left:100%;right:-100%}}

Â  /* RR.png sem â€œjanelaâ€ */
Â  .rr-holder{
Â  Â  display:grid; place-items:center; padding:0; background:transparent; border:0; box-shadow:none;
Â  }
Â  .rr-holder img{max-width:520px;width:100%;height:auto;filter:drop-shadow(0 20px 40px rgba(80,217,205,.24))}

Â  footer{margin:18px 0 6px;text-align:center}
Â  .copyright{font-size:12px;color:#e2e8f0}
</style>
</head>
<body>

Â  Â  <div class="wrap">
Â  Â  <div class="hero">
Â  Â  Â  <div class="hero-left">
Â  Â  Â  Â  <img class="logo-left" src="icon2.png"
Â  Â  Â  Â  Â  Â  Â onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/icon2.png';"
Â  Â  Â  Â  Â  Â  Â alt="Logo esquerdo">
Â  Â  Â  </div>
Â  Â  Â  <div class="hero-center"></div>
Â  Â  Â  <div class="hero-right">
Â  Â  Â  Â  <button id="toggleNote" type="button" class="iconbtn icon-note" title="Post-it">
Â  Â  Â  Â  Â  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
Â  Â  Â  Â  Â  Â  <path d="M8 3h8a3 3 0 0 1 3 3v7l-7 7H8a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3Z" stroke="#1f2937" stroke-width="2" fill="#fde68a"/>
Â  Â  Â  Â  Â  Â  <path d="M19 13h-4a3 3 0 0 0-3 3v4" stroke="#1f2937" stroke-width="2"/>
Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button id="toggleCalc" type="button" class="iconbtn icon-calc" title="Calculadora">
Â  Â  Â  Â  Â  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
Â  Â  Â  Â  Â  Â  <rect x="4" y="3" width="16" height="18" rx="2" stroke="#0b2555" stroke-width="2" fill="#dbeafe"/>
Â  Â  Â  Â  Â  Â  <rect x="7" y="6" width="10" height="3" rx="1" fill="#0b2555"/>
Â  Â  Â  Â  Â  Â  <path d="M8 12h2M8 16h2M12 12h2M12 16h2M16 12h2M16 16h2" stroke="#0b2555" stroke-width="2"/>
Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <img class="logo-hds" src="HDS.png"
Â  Â  Â  Â  Â  Â  Â onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/HDS.png';"
Â  Â  Â  Â  Â  Â  Â alt="HDSTEC">
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="grid">
Â  Â  Â  Â  Â  Â  <section class="card">
Â  Â  Â  Â  <div class="tag alertas">Alertas</div>
Â  Â  Â  Â  <h2>Controle de alerta</h2>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <button id="btnAlert" class="btn btn-search">Pesquisar</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="hint" id="alertBusy" style="display:none">
Â  Â  Â  Â  Â  <div class="busy"><div class="dots"><i></i><i></i><i></i></div><div>Pesquisando alerta...</div></div>
Â  Â  Â  Â  Â  <div class="bar" style="margin-top:6px"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="alertMsg"Â  style="display:none;font-size:22px;font-weight:900;color:#b91c1c;text-align:center;margin-top:8px">â€”</div>
Â  Â  Â  Â  <div id="alertResp" style="display:none;font-size:13px;font-weight:600;color:#334155;text-align:center;margin-top:4px;text-transform:lowercase">â€”</div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section class="card">
Â  Â  Â  Â  <div class="tag sites">Sites</div>
Â  Â  Â  Â  <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
Â  Â  Â  Â  <div class="row" style="margin-top:6px">
Â  Â  Â  Â  Â  <input id="qSites" class="input" placeholder="Digite sua pergunta .....">
Â  Â  Â  Â  Â  <button id="btnSites" class="btn btn-search">Pesquisar</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="hint" id="sitesBusy" style="display:none">
Â  Â  Â  Â  Â  <div class="busy"><div class="dots"><i></i><i></i><i></i></div><div>Pesquisando...</div></div>
Â  Â  Â  Â  Â  <div class="bar" style="margin-top:6px"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="outSites" class="out">â€”</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:10px;font-weight:800">PDFs (Scraping)
Â  Â  Â  Â  Â  <span id="affixCount" class="hint" style="margin-left:8px">0 resultado(s)</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="affixList" class="out">â€”</div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <div class="rr-holder">
Â  Â  Â  Â  <img src="rr.png"
Â  Â  Â  Â  Â  Â  Â onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/rr.png';"
Â  Â  Â  Â  Â  Â  Â alt="OlÃ¡, meu nome Ã© RIC. Precisa de uma ajuda?">
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <section class="card">
Â  Â  Â  Â  <div class="tag procs">Procedimentos</div>
Â  Â  Â  Â  <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <input id="qCRION" class="input" placeholder="Digite sua pergunta .....">
Â  Â  Â  Â  Â  <button id="btnCRION" class="btn btn-search">Pesquisar</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="hint" id="crionBusy" style="display:none">
Â  Â  Â  Â  Â  <div class="busy"><div class="dots"><i></i><i></i><i></i></div><div>Listando procedimentos...</div></div>
Â  Â  Â  Â  Â  <div class="bar" style="margin-top:6px"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="crionStatus" class="hint" style="margin-top:6px">â€”</div>
Â  Â  Â  Â  <ul id="crionList" style="margin:8px 0 0;padding:0;list-style:none"></ul>
Â  Â  Â  </section>
Â  Â  </div>

Â  Â  <footer style="margin:18px 0 8px;text-align:center">
Â  Â  Â  <span class="copyright">Desenvolvido por Alexandre Cavalcante V3.0-Operacao</span>
Â  Â  </footer>
Â  </div>

Â  Â  <div id="noteWrap" style="position:fixed;right:18px;top:86px;z-index:60;display:none;width:260px;background:#fff3b0;border:1px solid #f5d565;border-radius:12px;box-shadow:0 14px 30px #0001;padding:10px">
Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
Â  Â  Â  <b>Post-it</b>
Â  Â  Â  <div style="display:flex;gap:6px">
Â  Â  Â  Â  <button id="clearNote" class="btn btn-plain" style="padding:6px 10px">Limpar</button>
Â  Â  Â  Â  <button id="closeNote" class="btn btn-plain" style="padding:6px 10px">Fechar</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <textarea id="noteArea" placeholder="Anote algo..." style="width:100%;height:120px;border:0;background:transparent;outline:none;font:14px/1.45 ui-sans-serif"></textarea>
Â  </div>

Â  <div id="calcWrap" style="position:fixed;right:18px;top:260px;z-index:60;display:none;width:270px;background:#fff;border:1px solid #dbe0ea;border-radius:12px;box-shadow:0 14px 30px #0001;padding:12px">
Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
Â  Â  Â  <b>Calculadora</b>
Â  Â  Â  <button id="closeCalc" class="btn btn-plain" style="padding:6px 10px">Fechar</button>
Â  Â  </div>
Â  Â  <div class="screen" id="scr" style="border:1px solid var(--line);border-radius:10px;padding:10px;font-weight:700;margin-bottom:10px;background:#f9fbff">0</div>
Â  Â  <div class="keys" id="keys" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
Â  Â  Â  <div class="key op" data-k="C">C</div>
Â  Â  Â  <div class="key op" data-k="Â±">Â±</div>
Â  Â  Â  <div class="key op" data-k="%">%</div>
Â  Â  Â  <div class="key op" data-k="/">Ã·</div>
Â  Â  Â  <div class="key" data-k="7">7</div><div class="key" data-k="8">8</div><div class="key" data-k="9">9</div><div class="key op" data-k="*">Ã—</div>
Â  Â  Â  <div class="key" data-k="4">4</div><div class="key" data-k="5">5</div><div class="key" data-k="6">6</div><div class="key op" data-k="-">âˆ’</div>
Â  Â  Â  <div class="key" data-k="1">1</div><div class="key" data-k="2">2</div><div class="key" data-k="3">3</div><div class="key op" data-k="+">+</div>
Â  Â  Â  <div class="key" data-k="0">0</div><div class="key" data-k="00">00</div><div class="key" data-k=".">.</div><div class="key eq" data-k="=">=</div>
Â  Â  </div>
Â  Â  <style>
Â  Â  Â  .key{padding:10px;border-radius:10px;border:1px solid #e6e9f2;background:#f7f8fd;cursor:pointer;text-align:center;font-weight:800}
Â  Â  Â  .key.op{background:#eef6ff;border-color:#cfe7ff}
Â  Â  Â  .key.eq{background:linear-gradient(135deg,#22c55e,#a3e635);color:#053}
Â  Â  </style>
Â  </div>

<script>
/* ======= CONFIG ======= */
const APP_URL = "https://script.google.com/macros/s/AKfycbxnTEhSw1u5Ib0jCqJsURoZM30VfCpfeqKqKvYpXdKgJDUPrw8Q8hScbSzw4zVkI7u0rw/exec";

/* ======= HELPERS ======= */
const $ = s => document.querySelector(s);
const show = (el, on=true)=>{ if(!el) return; el.style.display = on? '' : 'none'; };
function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function cleanName(n){ return String(n||'').replace(/^(OCR_TMP_|TMP_SLIDES_)+/ig,''); }
function link(url, txt){ return `<a href="${url}" target="_blank" rel="noopener">${esc(txt||url)}</a>`; }
function humanSize(b){ if(!b||b<=0) return "â€”"; const u=["B","KB","MB","GB"]; let i=0; while(b>=1024&&i<u.length-1){ b/=1024; i++; } return b.toFixed(1)+" "+u[i]; }

/* ======= CHAMADAS ======= */
function call(endpoint, payload){
Â  const url = APP_URL + "?fn=" + encodeURIComponent(endpoint);
Â  return fetch(url, {
Â  Â  method:"POST",
Â  Â  headers:{ "Content-Type":"text/plain" },
Â  Â  body: JSON.stringify(payload || {})
Â  }).then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); });
}

/* ======= WIDGETS ======= */
const noteWrap = $('#noteWrap'), noteArea = $('#noteArea');
$('#toggleNote').onclick = ()=>{ noteWrap.style.display = noteWrap.style.display ? "" : "block"; if(noteWrap.style.display) noteArea.focus(); };
$('#clearNote').onclick = ()=>{ noteArea.value=""; localStorage.removeItem('ric_note'); };
$('#closeNote').onclick = ()=>{ noteWrap.style.display="none"; };
noteArea.value = localStorage.getItem('ric_note') || "";
noteArea.addEventListener('input', ()=> localStorage.setItem('ric_note', noteArea.value));

const calc = { buf:"0", op:null, mem:0, fresh:true };
function refresh(){ $('#scr').textContent = calc.buf; }
function press(k){
Â  if(/\d/.test(k)){ calc.buf = (calc.fresh||calc.buf==="0")? k : calc.buf+k; calc.fresh=false; return refresh(); }
Â  if(k==="00"){ press("0"); press("0"); return; }
Â  if(k==="."){ if(!calc.buf.includes(".")) calc.buf += "."; calc.fresh=false; return refresh(); }
Â  if(k==="C"){ calc.buf="0"; calc.op=null; calc.fresh=true; return refresh(); }
Â  if(k==="Â±"){ if(calc.buf!=="0") calc.buf = calc.buf.startsWith("-")? calc.buf.slice(1):"-"+calc.buf; return refresh(); }
Â  if(k==="%"){ calc.buf = String(parseFloat(calc.buf)/100); return refresh(); }
Â  if("+-*/".includes(k)){ calc.mem=parseFloat(calc.buf); calc.op=k; calc.fresh=true; return; }
Â  if(k==="=" && calc.op){
Â  Â  const a=calc.mem, b=parseFloat(calc.buf);
Â  Â  let v=0; switch(calc.op){case "+":v=a+b;break;case "-":v=a-b;break;case "*":v=a*b;break;case "/":v=b===0? "Erro" : a/b;break;}
Â  Â  calc.buf=String(v); calc.op=null; calc.fresh=true; return refresh();
Â  }
}
$('#keys').addEventListener('click', e=>{ const k=e.target.dataset.k; if(k) press(k); });
$('#toggleCalc').onclick = ()=>{ $('#calcWrap').style.display = $('#calcWrap').style.display? "" : "block"; refresh(); };
$('#closeCalc').onclick = ()=>{ $('#calcWrap').style.display="none"; };

/* ======= ALERTA ======= */
$('#btnAlert').addEventListener('click', async ()=>{
Â  const msg=$('#alertMsg'), resp=$('#alertResp');
Â  show(msg,false); show(resp,false); show($('#alertBusy'),true);
Â  try{
Â  Â  const r = await call('getalert',{});
Â  Â  if(!r || r.ok===false){ msg.textContent="Falha ao consultar."; show(msg,true); return; }
Â  Â  if(!r.found){ msg.textContent="Sem recado no momento."; show(msg,true); return; }
Â  Â  msg.textContent = "ğŸš¨ " + String(r.mensagem||"â€”").toUpperCase(); show(msg,true);
Â  Â  if(r.responsavel){ resp.textContent = String(r.responsavel||"").toLowerCase(); show(resp,true); }
Â  }catch(e){ msg.textContent="Erro: "+(e.message||e); show(msg,true);
Â  }finally{ show($('#alertBusy'),false); }
});

/* ======= AFFIX PDFs (CSV local) ======= */
/* CSV esperado em: data/affix/affix_pdfs_manifest.csvÂ  (cabeÃ§alho: name,url) */
const AFFIX_CSV_URL = "data/affix/affix_pdfs_manifest.csv";
let AFFIX_PDFS = [];

async function loadAffixCSV(){
Â  if (AFFIX_PDFS.length) return;
Â  const res = await fetch(AFFIX_CSV_URL);
Â  const text = await res.text();
Â  AFFIX_PDFS = parseAffixCSV(text);
}

function parseAffixCSV(text){
Â  const lines = text.trim().split(/\r?\n/);
Â  if (!lines.length) return [];
Â  const out = [];
Â  for (let i=1; i<lines.length; i++){
Â  Â  const line = lines[i].trim();
Â  Â  if (!line) continue;
Â  Â  const idx = line.indexOf(",");
Â  Â  if (idx === -1) continue;
Â  Â  const name = line.slice(0, idx).trim();
Â  Â  const urlÂ  = line.slice(idx + 1).trim();
Â  Â  if (name && url) out.push({ name, url });
Â  }
Â  return out;
}

function toggleAffixPrev(i){
Â  const el = document.getElementById("affix_prev_" + i);
Â  if (!el) return;
Â  el.style.display = (el.style.display === "none" || !el.style.display) ? "block" : "none";
}

function googleViewerURL(fileUrl){
Â  return "https://docs.google.com/viewer?embedded=true&url=" + encodeURIComponent(fileUrl);
}

async function searchAffixPDFs(q){
Â  const listÂ  = $('#affixList');
Â  const badge = $('#affixCount');
Â  try { await loadAffixCSV(); }
Â  catch(e){ badge.textContent='erro ao ler CSV'; list.textContent='Falha: '+(e.message||e); return; }

Â  const term = (q||'').toLowerCase().trim();
Â  if(!term){ badge.textContent='0 resultado(s)'; list.textContent='â€”'; return; }

Â  const tokens = term.split(/\s+/).filter(Boolean);
Â  const results = AFFIX_PDFS.filter(r =>
Â  Â  tokens.every(t =>
Â  Â  Â  (r.name && r.name.toLowerCase().includes(t)) ||
Â  Â  Â  (r.urlÂ  && r.url.toLowerCase().includes(t))
Â  Â  )
Â  );

Â  badge.textContent = `${results.length} resultado(s)`;
Â  if(!results.length){ list.textContent='â€”'; return; }

Â  list.innerHTML = '';
Â  let i = 0;
Â  function pump(){
Â  Â  const frag = document.createDocumentFragment();
Â  Â  for(let k=0; k<10 && i<results.length; k++, i++){
Â  Â  Â  const r = results[i];
Â  Â  Â  const row = document.createElement('div');
Â  Â  Â  row.className = 'affix-row';
Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  <div><b>${esc(r.name)}</b></div>
Â  Â  Â  Â  <div class="affix-actions">
Â  Â  Â  Â  Â  <button class="btn btn-plain" onclick="window.open('${r.url}','_blank')">Abrir</button>
Â  Â  Â  Â  Â  <button class="btn btn-plain" onclick="toggleAffixPrev(${i})">PrÃ©via</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="affix_prev_${i}" class="affix-prev">
Â  Â  Â  Â  Â  <iframe
Â  Â  Â  Â  Â  Â  src="${googleViewerURL(r.url)}"
Â  Â  Â  Â  Â  Â  referrerpolicy="no-referrer"
Â  Â  Â  Â  Â  Â  loading="lazy"></iframe>
Â  Â  Â  Â  </div>`;
Â  Â  Â  frag.appendChild(row);
Â  Â  }
Â  Â  list.appendChild(frag);
Â  Â  if(i < results.length) requestAnimationFrame(pump);
Â  }
Â  pump();
}

/* ======= SITES ======= */
$('#btnSites').addEventListener('click', doSites);
$('#qSites').addEventListener('keydown', e=>{ if(e.key==='Enter') doSites(); });
async function doSites(){
Â  const q=($('#qSites').value||'').trim();

Â  /* Busca no Ã­ndice local de PDFs em paralelo */
Â  searchAffixPDFs(q);

Â  if(!q){ $('#outSites').textContent='Digite a pergunta.'; return; }
Â  show($('#sitesBusy'),true); $('#outSites').textContent='â€”';
Â  try{
Â  Â  const qRich = q + " â€” FORMATO: responda em portuguÃªs com texto Ãºtil e liste as URLs oficiais no final. Substitua observaÃ§Ãµes por: 'Fontes oficiais Affix, Alter, Hapvida'.";
Â  Â  const r = await call('chat',{q:qRich});
Â  Â  const txt = (r && r.text) ? r.text : 'â€”';
Â  Â  const html = String(txt).replace(/(https?:\/\/[^\s]+)/g, m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
Â  Â  $('#outSites').innerHTML = html;
Â  }catch(e){ $('#outSites').textContent='Erro: '+(e.message||e);
Â  }finally{ show($('#sitesBusy'),false); }
}

/* ======= CRION ======= */
$('#btnCRION').addEventListener('click', doCRION);
$('#qCRION').addEventListener('keydown', e=>{ if(e.key==='Enter') doCRION(); });
async function doCRION(){
Â  const q=($('#qCRION').value||'').trim();
Â  if(!q){ $('#crionStatus').textContent='Digite um termo.'; return; }
Â  show($('#crionBusy'),true); $('#crionStatus').textContent='Listando arquivosâ€¦'; $('#crionList').innerHTML="";
Â  try{
Â  Â  const res = await call('searchcrion',{q});
Â  Â  if(!res || res.ok===false){ $('#crionStatus').textContent='Erro ao buscar: '+(res&&res.message?res.message:''); return; }
Â  Â  const items=res.items||[]; $('#crionStatus').textContent=`Resultados: ${items.length}`;
Â  Â  const frag=document.createDocumentFragment();
Â  Â  items.forEach((it,idx)=>{
Â  Â  Â  const li=document.createElement('li'); li.style.padding="10px 0"; li.style.borderTop="1px solid var(--line)"; li.id='crion_'+idx;
Â  Â  Â  const metaÂ  = `<div class="hint">Tamanho: ${humanSize(it.size||0)} â€¢ Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "â€”"}</div>`;
Â  Â  Â  li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> â€¢ ${link(it.url,'Abrir')}</div>${meta}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="hint" id="snip_crion_${idx}">Carregando prÃ©viasâ€¦</div>`;
Â  Â  Â  frag.appendChild(li);
Â  Â  });
Â  Â  $('#crionList').appendChild(frag);
Â  Â  if(items.length){
Â  Â  Â  let from=0;
Â  Â  Â  while(from < items.length){
Â  Â  Â  Â  const r = await call('fetchcrionsnippets',{sessionId:res.sessionId, from, limit:6});
Â  Â  Â  Â  (r.items||[]).forEach(row=>{
Â  Â  Â  Â  Â  const el=$('#snip_crion_'+row.index);
Â  Â  Â  Â  Â  el.innerHTML=(row.snippets && row.snippets.length)? row.snippets.map(s=>`<div style="color:#374151;margin:6px 0">${esc(s)}</div>`).join("") : '<span class="hint">â€”</span>';
Â  Â  Â  Â  });
Â  Â  Â  Â  from = r.to;
Â  Â  Â  }
Â  Â  Â  $('#crionStatus').textContent += " â€¢ prÃ©vias completas";
Â  Â  }
Â  }catch(e){ $('#crionStatus').textContent='Erro: '+(e.message||e);
Â  }finally{ show($('#crionBusy'),false); }
}
</script>
</body>
</html>

<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RIC AI ‚Äî CRION</title>
<link rel="manifest" href="manifest.json"/>
<style>
  :root{
    --brand:#2882bb; --brand2:#2a8fcf;
    --bg:#f7f8fc; --ink:#0f172a; --muted:#667085; --line:#E7EAF3;
    --lime:#22c55e; --lime2:#a3e635; --danger:#ef4444;
    --tag:#F2E7FF; --tag-ink:#6D28D9;
    --card-shadow:0 18px 36px rgba(99,102,241,.12), 0 8px 24px rgba(40,130,187,.10);
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--ink);
       background:radial-gradient(1200px 520px at -10% -10%, #eaf4ff 0, #ffffff 60%, #f7faff 100%)}
  .wrap{max-width:1290px;margin:0 auto;padding:16px}
  /* header */
  .hero{display:flex;align-items:center;justify-content:space-between;gap:12px;
        border-radius:18px;padding:12px 16px;color:#fff;
        background:linear-gradient(135deg,var(--brand),var(--brand2));
        box-shadow:0 24px 56px rgba(40,130,187,.22)}
  .logo-left,.logo-right{height:44px;object-fit:contain;filter:drop-shadow(0 2px 6px #0002)}
  .tools{display:flex;gap:10px}
  .iconbtn{width:36px;height:36px;border-radius:12px;border:1px solid #ffffff40;
           display:grid;place-items:center;background:#ffffff1a;backdrop-filter:blur(4px);cursor:pointer}
  /* grid/cards */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--card-shadow)}
  .tag{display:inline-flex;align-items:center;gap:8px;background:var(--tag);color:var(--tag-ink);
       border:1px solid #eadbff;border-radius:999px;padding:6px 12px;font-weight:800;font-size:12px}
  h2{margin:8px 0 10px;font-size:18px}
  .row{display:flex;gap:10px;align-items:center}
  .input{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fbfcff}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn-search{color:#053;background:linear-gradient(135deg,var(--lime),var(--lime2));box-shadow:0 10px 22px rgba(34,197,94,.28)}
  .btn-plain{background:#f7f7fb;color:#111;border:1px solid var(--line)}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .out{white-space:pre-wrap;min-height:96px;border:1px dashed #c9d5ea;border-radius:12px;padding:10px;margin-top:10px;background:#f3f6ff}
  .busy{display:flex;align-items:center;gap:8px}
  .spinner{width:16px;height:16px;border-radius:50%;border:3px solid #ffffff66;border-top-color:#fff;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .bar{position:relative;height:6px;border-radius:999px;background:#e9e9ff;overflow:hidden}
  .bar:before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,#c7b8ff,#a78bfa,#93c5fd);animation:load 1.2s infinite}
  @keyframes load{0%{left:-100%;right:100%}50%{left:0;right:0}100%{left:100%;right:-100%}}

  /* RR.png com a mesma ‚Äúsombra roxa‚Äù dos cards */
  .rr{display:block;width:100%;aspect-ratio:16/11;object-fit:contain;border-radius:14px;
      box-shadow:var(--card-shadow);border:1px solid var(--line);background:#fff}
  .pdf-item{padding:10px 0;border-top:1px solid var(--line)}
  .pdf-actions{display:flex;gap:8px;margin-top:6px}
  .pdf-actions .btn{padding:6px 10px}
  iframe.preview{width:100%;height:520px;border:1px solid var(--line);border-radius:10px;margin-top:8px}
  footer{margin:18px 0 6px;text-align:center;font-size:12px;color:#2882bb}
</style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <img class="logo-left" src="icon2.png" onerror="this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/icon2.png'">
      <div class="tools">
        <button class="iconbtn" title="Post-it" id="toggleNote">üìù</button>
        <button class="iconbtn" title="Calculadora" id="toggleCalc">üßÆ</button>
      </div>
      <img class="logo-right" src="HDS.png" onerror="this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/HDS.png'">
    </header>

    <div class="grid">
      <!-- ALERTA -->
      <section class="card">
        <div class="tag">ALERTA</div>
        <h2>Controle de alerta</h2>
        <div class="row"><button id="btnAlert" class="btn btn-search">Pesquisar</button></div>
        <div class="hint" id="alertBusy" style="display:none">
          <div class="busy"><div class="spinner"></div><div>Pesquisando alerta...</div></div><div class="bar" style="margin-top:6px"></div>
        </div>
        <div class="out" id="alertBox" style="display:none">
          <div id="alertMsg" style="font-size:22px;font-weight:900;color:#b91c1c">‚Äî</div>
          <div id="alertResp" class="hint">‚Äî</div>
        </div>

        <!-- RR.png -->
        <img class="rr" src="rr.png" alt="RIC" style="margin-top:10px"
             onerror="this.src='https://raw.githubusercontent.com/HD-TECH-hash/Ricai-crion-operacao/main/rr.png'">
      </section>

      <!-- SITES OFICIAIS -->
      <section class="card">
        <div class="tag">SITES OFICIAIS</div>
        <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
        <div class="row" style="margin-top:6px">
          <input id="qSites" class="input" placeholder="Digite sua pergunta .....">
          <button id="btnSites" class="btn btn-search">Pesquisar</button>
        </div>
        <div class="hint" id="sitesBusy" style="display:none">
          <div class="busy"><div class="spinner"></div><div>Pesquisando...</div></div><div class="bar" style="margin-top:6px"></div>
        </div>
        <div id="outSites" class="out">‚Äî</div>
      </section>

      <!-- PDFs do reposit√≥rio -->
      <section class="card" style="grid-column:1 / -1">
        <div class="tag">PDFs</div>
        <h2>Manuais do Corretor (reposit√≥rio Git)</h2>
        <p class="hint">Os PDFs s√£o atualizados pelo rob√¥ (scripts/fetch_affix.py). Pesquise pelo nome do arquivo.</p>
        <div class="row">
          <input id="qPDF" class="input" placeholder="Ex.: manual backoffice recife">
          <button id="btnPDF" class="btn btn-search">Pesquisar</button>
        </div>
        <div class="hint" id="pdfBusy" style="display:none">
          <div class="busy"><div class="spinner"></div><div>Carregando manifest‚Ä¶</div></div><div class="bar" style="margin-top:6px"></div>
        </div>
        <div class="out">
          <div id="pdfStatus" class="hint">‚Äî</div>
          <ul id="pdfList" style="margin:8px 0 0;padding:0;list-style:none"></ul>
        </div>
      </section>
    </div>

    <footer>¬© 2025 HDSTEC ‚Äî v3.0.0 Opera√ß√£o</footer>
  </div>

<script>
/* ---------- CONFIG ---------- */
const APP_URL = "https://script.google.com/macros/s/AKfycbxnTEhSw1u5Ib0jCqJsURoZM30VfCpfeqKqKvYpXdKgJDUPrw8Q8hScbSzw4zVkI7u0rw/exec";
const PDF_MANIFEST_URL = "./data/affix/manifest.json";

/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const show = (el, on=true)=>{ if(!el) return; el.style.display = on? '' : 'none'; };
function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

/* ---------- low-level call (text/plain evita preflight) ---------- */
function call(endpoint, payload){
  const url = APP_URL + "?fn=" + encodeURIComponent(endpoint);
  return fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"text/plain" },
    body: JSON.stringify(payload||{})
  }).then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); });
}

/* ---------- ALERTA ---------- */
$('#btnAlert').addEventListener('click', async ()=>{
  show($('#alertBusy'),true); show($('#alertBox'),false);
  try{
    const r = await call('getalert',{});
    const msg = $('#alertMsg'), resp = $('#alertResp');
    if(r && r.ok && r.found){
      msg.textContent = "üö® " + String(r.mensagem||"").toUpperCase();
      resp.textContent = r.responsavel ? String(r.responsavel).toLowerCase() : "";
    }else{
      msg.textContent = "Sem recado no momento."; resp.textContent = "";
    }
    show($('#alertBox'),true);
  }catch(e){
    $('#alertMsg').textContent="Erro: "+(e.message||e); $('#alertResp').textContent=""; show($('#alertBox'),true);
  }finally{ show($('#alertBusy'),false); }
});

/* ---------- SITES ---------- */
$('#btnSites').addEventListener('click', doSites);
$('#qSites').addEventListener('keydown', e=>{ if(e.key==='Enter') doSites(); });
async function doSites(){
  const q=($('#qSites').value||'').trim();
  if(!q){ $('#outSites').textContent='Digite a pergunta.'; return; }
  show($('#sitesBusy'),true); $('#outSites').textContent='‚Äî';
  try{
    const qRich = q + " ‚Äî FORMATO: portugu√™s + liste URLs oficiais ao final. Substitua notas por 'Fontes oficiais Affix, Alter, Hapvida'.";
    const r = await call('chat',{q:qRich, ua:navigator.userAgent||''});
    const txt = (r && r.text) ? r.text : '‚Äî';
    const html = String(txt).replace(/(https?:\/\/[^\s]+)/g, m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
    $('#outSites').innerHTML = html;
  }catch(e){ $('#outSites').textContent='Erro: '+(e.message||e);
  }finally{ show($('#sitesBusy'),false); }
}

/* ---------- PDFs (manifest do repo) ---------- */
let _pdfManifest=null;
async function loadManifest(){
  if(_pdfManifest) return _pdfManifest;
  const r = await fetch(PDF_MANIFEST_URL, {cache:'no-store'});
  if(!r.ok) throw new Error("Manifest n√£o encontrado");
  _pdfManifest = await r.json();
  return _pdfManifest;
}
$('#btnPDF').addEventListener('click', doPDF);
$('#qPDF').addEventListener('keydown', e=>{ if(e.key==='Enter') doPDF(); });
async function doPDF(){
  const q=($('#qPDF').value||'').trim().toLowerCase();
  if(!q){ $('#pdfStatus').textContent='Digite um termo para filtrar.'; return; }
  show($('#pdfBusy'),true); $('#pdfStatus').textContent='Carregando‚Ä¶'; $('#pdfList').innerHTML="";
  try{
    const m = await loadManifest();
    const items = (m.items||[]).filter(it => String(it.name||'').toLowerCase().includes(q));
    $('#pdfStatus').textContent = `Resultados: ${items.length} ‚Ä¢ filtro: ‚Äú${q}‚Äù`;
    const frag=document.createDocumentFragment();
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.className='pdf-item';
      const openUrl = `./data/affix/raw/${encodeURIComponent(it.name)}`;
      li.innerHTML = `
        <div><b>${esc(it.name)}</b></div>
        <div class="hint">Tamanho: ${ (it.size? (it.size/1024/1024).toFixed(2)+' MB' : '‚Äî') }</div>
        <div class="pdf-actions">
          <a class="btn btn-plain" href="${openUrl}" target="_blank" rel="noopener">Abrir</a>
          <button class="btn btn-plain" data-prev="${openUrl}">Pr√©via</button>
        </div>
        <div class="preview-wrap"></div>
      `;
      frag.appendChild(li);
    });
    $('#pdfList').appendChild(frag);

    // toggle pr√©via
    $('#pdfList').addEventListener('click', e=>{
      const u=e.target && e.target.dataset && e.target.dataset.prev;
      if(!u) return;
      const wrap = e.target.closest('li').querySelector('.preview-wrap');
      if(wrap.dataset.open==='1'){ wrap.innerHTML=''; wrap.dataset.open='0'; return; }
      wrap.innerHTML = `<iframe class="preview" src="${u}#toolbar=1&view=FitH" loading="lazy"></iframe>`;
      wrap.dataset.open='1';
    }, {once:true}); // delega apenas uma vez
  }catch(e){ $('#pdfStatus').textContent='Erro: '+(e.message||e);
  }finally{ show($('#pdfBusy'),false); }
}

/* ---------- widgets simples (nota/calc) ---------- */
document.getElementById('toggleNote').onclick = ()=> alert('Dica: use o bloco de notas do navegador üòâ');
document.getElementById('toggleCalc').onclick = ()=> alert('Abra a calculadora do sistema.');

/* ---------- SW opcional ---------- */
if ("serviceWorker" in navigator) { navigator.serviceWorker.register("./sw.js").catch(()=>{}); }
</script>
</body>
</html>
